{% extends "base.html" %}

{% block title %}Scoring Criteria - Idealista Land Watch{% endblock %}

{% block content %}
<div class="row">
    <div class="col-lg-8 mx-auto">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-sliders-h me-2"></i>
                Scoring Criteria
            </h1>
            <a href="{{ url_for('main.lands') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Properties
            </a>
        </div>

        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0">Scoring Weights Configuration</h5>
            </div>
            <div class="card-body">
                <form method="POST" action="{{ url_for('main.update_criteria') }}" id="criteria-form">
                    {% for criterion in criteria %}
                        <div class="row mb-4">
                            <div class="col-md-4">
                                <label for="weight_{{ criterion.criteria_name }}" class="form-label fw-bold">
                                    {{ criterion.criteria_name.replace('_', ' ').title() }}
                                </label>
                                <p class="small text-muted mb-0">
                                    {% if criterion.criteria_name == 'location_quality' %}
                                        Proximity to urban centers, municipality prestige, neighborhood quality
                                    {% elif criterion.criteria_name == 'transport' %}
                                        Public transport access, highways, airports, train stations
                                    {% elif criterion.criteria_name == 'infrastructure_basic' %}
                                        Water, electricity, sewerage, internet connectivity
                                    {% elif criterion.criteria_name == 'infrastructure_extended' %}
                                        Gas, telecommunications, public services infrastructure
                                    {% elif criterion.criteria_name == 'environment' %}
                                        Environmental quality, views, natural features, orientation
                                    {% elif criterion.criteria_name == 'physical_characteristics' %}
                                        Land size, shape, topography, price per square meter
                                    {% elif criterion.criteria_name == 'services_quality' %}
                                        Schools, hospitals, shopping, restaurants quality ratings
                                    {% elif criterion.criteria_name == 'legal_status' %}
                                        Zoning status, building permissions, land classification
                                    {% elif criterion.criteria_name == 'development_potential' %}
                                        Future development possibilities, urbanization plans
                                    {% else %}
                                        Custom scoring criterion
                                    {% endif %}
                                </p>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center">
                                    <button type="button" class="btn btn-sm btn-outline-secondary me-2 weight-adjust" data-criteria="{{ criterion.criteria_name }}" data-delta="-0.05">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <input type="range" 
                                           class="form-range flex-grow-1 me-2 weight-slider" 
                                           id="slider_{{ criterion.criteria_name }}"
                                           data-criteria="{{ criterion.criteria_name }}"
                                           value="{{ criterion.weight * 100 }}"
                                           min="0" 
                                           max="100" 
                                           step="1">
                                    <input type="number" 
                                           class="form-control weight-input" 
                                           id="weight_{{ criterion.criteria_name }}"
                                           name="weight_{{ criterion.criteria_name }}"
                                           value="{{ criterion.weight }}"
                                           min="0" 
                                           max="1" 
                                           step="0.01"
                                           style="width: 80px;"
                                           required>
                                    <button type="button" class="btn btn-sm btn-outline-secondary ms-2 weight-adjust" data-criteria="{{ criterion.criteria_name }}" data-delta="0.05">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <!-- Weight percentage visualization -->
                                <div class="mt-2">
                                    <div class="progress">
                                        <div class="progress-bar" 
                                             id="progress_{{ criterion.criteria_name }}"
                                             style="width: {{ (criterion.weight * 10) }}%"
                                             data-weight="{{ criterion.weight }}">
                                        </div>
                                    </div>
                                    <small class="text-muted">
                                        <span id="percent_{{ criterion.criteria_name }}" class="fw-bold">{{ "%.1f"|format(criterion.weight * 100) }}%</span>
                                    </small>
                                </div>
                            </div>
                        </div>
                    {% endfor %}

                    <hr class="my-4">

                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <button type="submit" class="btn btn-success">
                                <i class="fas fa-save me-2"></i>
                                Update Weights & Rescore All Properties
                            </button>
                            <button type="reset" class="btn btn-outline-secondary ms-2">
                                <i class="fas fa-undo me-2"></i>
                                Reset
                            </button>
                        </div>
                        <div class="text-end">
                            <div>
                                <div class="progress mb-1" style="height: 25px;">
                                    <div id="total-weight-bar" class="progress-bar" role="progressbar" style="width: 100%">
                                        <span id="total-weight-text" class="fw-bold">100%</span>
                                    </div>
                                </div>
                                <small class="text-muted">
                                Last Updated: 
                                {% if criteria %}
                                    {{ criteria[0].updated_at.strftime('%Y-%m-%d %H:%M') if criteria[0].updated_at else 'Never' }}
                                {% else %}
                                    Never
                                {% endif %}
                            </small>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Current Scoring Example -->
        <div class="card mt-4">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-calculator me-2"></i>
                    How Scoring Works
                </h6>
            </div>
            <div class="card-body">
                <p class="small text-muted mb-3">
                    Each property is scored on a 0-100 scale for each criterion. The final score is a weighted average:
                </p>
                
                <div class="bg-dark p-3 rounded font-monospace small">
                    <div class="text-warning">Final Score = Σ(Criterion Score × Weight)</div>
                    <div class="mt-2 text-muted">
                        Example: Location(80 × 0.20) + Transport(70 × 0.15) + Infrastructure(60 × 0.20) + ... = 67.5 points
                    </div>
                    <div class="mt-2 text-info">
                        Maximum possible score: 100 points (when all criteria score 100%)
                    </div>
                </div>

                <div class="mt-3">
                    <h6>Professional Scoring Ranges (Spanish/European Standards):</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <span class="badge bg-success">80-100</span> Investment Grade
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-info">60-79</span> High Quality
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-warning">40-59</span> Acceptable
                        </div>
                        <div class="col-md-3">
                            <span class="badge bg-danger">0-39</span> Below Standards
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Methodology info -->
        <div class="mt-4 text-center">
            <small class="text-muted" style="font-size: 0.75rem;">
                <i class="fas fa-info-circle me-1"></i>
                Adjust the weights for each scoring criterion. Changes will trigger automatic rescoring of all properties. 
                Weights are relative - they don't need to sum to 1.0.
                <br>
                <span style="font-size: 0.7rem;">
                    Методика MCDM (Multi-Criteria Decision Making): Веса должны в сумме давать 1.0 (100%). 
                    При изменении одного веса остальные пропорционально корректируются.
                    <br>
                    Используется в профессиональной оценке недвижимости по стандартам ISO 31000 и RICS.
                </span>
            </small>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('criteria-form');
    const inputs = form.querySelectorAll('input.weight-input');
    const sliders = form.querySelectorAll('input.weight-slider');
    const adjustButtons = form.querySelectorAll('button.weight-adjust');
    let isAdjusting = false;
    
    function updateVisualizations() {
        let totalWeight = 0;
        
        inputs.forEach(input => {
            const criteriaName = input.name.replace('weight_', '');
            const weight = parseFloat(input.value) || 0;
            const progressBar = document.getElementById(`progress_${criteriaName}`);
            const percentSpan = document.getElementById(`percent_${criteriaName}`);
            const slider = document.getElementById(`slider_${criteriaName}`);
            
            totalWeight += weight;
            
            // Update progress bar (now showing actual percentage)
            const percentage = weight * 100;
            if (progressBar) {
                progressBar.style.width = `${percentage}%`;
                progressBar.setAttribute('data-weight', weight);
            }
            
            // Update percentage text
            if (percentSpan) {
                percentSpan.textContent = `${percentage.toFixed(1)}%`;
            }
            
            // Update slider
            if (slider && !isAdjusting) {
                slider.value = percentage;
            }
            
            // Color code based on weight
            if (progressBar) {
                if (weight > 0.3) {
                    progressBar.className = 'progress-bar bg-success';
                } else if (weight > 0.1) {
                    progressBar.className = 'progress-bar bg-warning';
                } else {
                    progressBar.className = 'progress-bar bg-danger';
                }
            }
        });
        
        // Update total weight indicator
        const totalWeightBar = document.getElementById('total-weight-bar');
        const totalWeightText = document.getElementById('total-weight-text');
        
        if (totalWeightBar && totalWeightText) {
            const totalPercent = totalWeight * 100;
            totalWeightText.textContent = `${totalPercent.toFixed(1)}%`;
            totalWeightBar.style.width = `${Math.min(totalPercent, 100)}%`;
            
            // Color code total weight
            if (Math.abs(totalWeight - 1.0) < 0.01) {
                totalWeightBar.className = 'progress-bar bg-success';
            } else if (Math.abs(totalWeight - 1.0) < 0.1) {
                totalWeightBar.className = 'progress-bar bg-warning';
            } else {
                totalWeightBar.className = 'progress-bar bg-danger';
            }
        }
    }
    
    function adjustWeightsProportionally(changedCriteria, newWeight) {
        isAdjusting = true;
        const oldWeight = parseFloat(document.getElementById(`weight_${changedCriteria}`).value) || 0;
        const delta = newWeight - oldWeight;
        
        // Set the changed weight
        document.getElementById(`weight_${changedCriteria}`).value = newWeight.toFixed(2);
        
        // If proportional adjustment is enabled (check for a toggle or always do it)
        if (delta !== 0) {
            let totalOtherWeights = 0;
            const otherWeights = [];
            
            // Calculate total of other weights
            inputs.forEach(input => {
                const criteriaName = input.name.replace('weight_', '');
                if (criteriaName !== changedCriteria) {
                    const weight = parseFloat(input.value) || 0;
                    totalOtherWeights += weight;
                    otherWeights.push({name: criteriaName, weight: weight});
                }
            });
            
            // Distribute the delta proportionally among other weights
            if (totalOtherWeights > 0) {
                otherWeights.forEach(item => {
                    const proportion = item.weight / totalOtherWeights;
                    const adjustment = -delta * proportion;
                    const newValue = Math.max(0, Math.min(1, item.weight + adjustment));
                    document.getElementById(`weight_${item.name}`).value = newValue.toFixed(2);
                });
            }
        }
        
        isAdjusting = false;
        updateVisualizations();
    }
    
    // Slider change handler
    sliders.forEach(slider => {
        slider.addEventListener('input', function() {
            const criteriaName = this.dataset.criteria;
            const newWeight = parseFloat(this.value) / 100;
            adjustWeightsProportionally(criteriaName, newWeight);
        });
    });
    
    // Input change handler
    inputs.forEach(input => {
        input.addEventListener('input', function() {
            if (!isAdjusting) {
                const criteriaName = this.name.replace('weight_', '');
                const newWeight = Math.max(0, Math.min(1, parseFloat(this.value) || 0));
                this.value = newWeight.toFixed(2);
                adjustWeightsProportionally(criteriaName, newWeight);
            }
        });
    });
    
    // Plus/Minus button handlers
    adjustButtons.forEach(button => {
        button.addEventListener('click', function() {
            const criteriaName = this.dataset.criteria;
            const delta = parseFloat(this.dataset.delta);
            const input = document.getElementById(`weight_${criteriaName}`);
            const currentWeight = parseFloat(input.value) || 0;
            const newWeight = Math.max(0, Math.min(1, currentWeight + delta));
            adjustWeightsProportionally(criteriaName, newWeight);
        });
    });
    
    // Initial update
    updateVisualizations();
    
    // Form submission confirmation
    form.addEventListener('submit', function(e) {
        const totalWeight = Array.from(inputs).reduce((sum, input) => {
            return sum + (parseFloat(input.value) || 0);
        }, 0);
        
        if (Math.abs(totalWeight - 1.0) > 0.01) {
            if (!confirm(`Внимание: Сумма весов ${(totalWeight * 100).toFixed(1)}% отличается от 100%. Рекомендуется сумма = 100% для корректной оценки. Продолжить?`)) {
                e.preventDefault();
                return false;
            }
        }
        
        if (!confirm(`Это обновит веса и пересчитает оценки всех объектов. Продолжить?`)) {
            e.preventDefault();
            return false;
        }
    });
});
</script>
{% endblock %}
