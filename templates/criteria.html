{% extends "base.html" %}

{% block title %}Scoring Criteria - Idealista Land Watch{% endblock %}

{% block content %}
<div class="md3-container">
    <!-- Page Header -->
    <div class="md3-page-header">
        <div style="display: flex; justify-content: space-between; align-items: center;">
            <h1 class="md3-page-title">
                <span class="material-symbols-outlined">tune</span>
                Dual Scoring System Configuration
            </h1>
            <a href="{{ url_for('main.lands') }}" class="md3-button md3-button--outlined">
                <span class="material-symbols-outlined">arrow_back</span>
                Back to Properties
            </a>
        </div>
    </div>

    <!-- Profile Navigation Tabs -->
    <div class="md3-tabs" id="profileTabs" role="tablist">
        <button class="md3-tab md3-tab--active" 
                id="investment-tab" 
                data-target="investment" 
                type="button" 
                role="tab" 
                aria-controls="investment" 
                aria-selected="true">
            <span class="material-symbols-outlined" style="color: #f57c00;">trending_up</span>
            Investment
        </button>
        <button class="md3-tab" 
                id="lifestyle-tab" 
                data-target="lifestyle" 
                type="button" 
                role="tab" 
                aria-controls="lifestyle" 
                aria-selected="false">
            <span class="material-symbols-outlined" style="color: #2e7d32;">home</span>
            Lifestyle
        </button>
        <button class="md3-tab" 
                id="combined-tab" 
                data-target="combined" 
                type="button" 
                role="tab" 
                aria-controls="combined" 
                aria-selected="false">
            <span class="material-symbols-outlined">balance</span>
            Combined
        </button>
    </div>

    <!-- Tab Content -->
    <div id="profileTabsContent">
        <!-- Investment Profile Tab -->
        <div class="md3-tab-content md3-tab-content--active" id="investment" role="tabpanel" aria-labelledby="investment-tab">
            <div class="md3-card md3-card--elevated">
                <div class="md3-card__header">
                    <h2 class="title-large" style="color: #f57c00;">
                        <span class="material-symbols-outlined">trending_up</span>
                        Investment Profile
                    </h2>
                </div>
                <div class="md3-card__content">
                    <form method="POST" action="{{ url_for('main.update_criteria_profile', profile='investment') }}" id="investment-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Investment Profile Criteria -->
                        {% for criterion, weight in investment_weights.items() %}
                            {% if weight > 0 %}
                                <div class="md3-form-row">
                                    <div class="md3-form-group">
                                        <label class="title-medium">
                                            {{ format_field_name(criterion) }}
                                        </label>
                                        <p class="md3-form-helper">{{ criteria_descriptions.get(criterion, 'Custom scoring criterion') }}</p>
                                    </div>
                                    <div class="md3-form-group">
                                        <div class="md3-form-controls">
                                            <button type="button" class="md3-button md3-button--icon weight-adjust" 
                                                    data-criteria="{{ criterion }}" data-profile="investment" data-delta="-0.05">
                                                <span class="material-symbols-outlined">remove</span>
                                            </button>
                                            <div class="md3-slider" style="flex-grow: 1;">
                                                <input type="range" 
                                                       class="md3-slider__input weight-slider" 
                                                       id="investment_slider_{{ criterion }}"
                                                       data-criteria="{{ criterion }}"
                                                       data-profile="investment"
                                                       value="{{ (weight * 100)|round }}"
                                                       min="0" 
                                                       max="100" 
                                                       step="1">
                                            </div>
                                            <div class="md3-text-field md3-number-field">
                                                <input type="number" 
                                                       class="md3-text-field__input weight-input" 
                                                       id="investment_weight_{{ criterion }}"
                                                       name="weight_{{ criterion }}"
                                                       value="{{ weight|round(2) }}"
                                                       min="0" 
                                                       max="1" 
                                                       step="0.01"
                                                       required>
                                            </div>
                                            <button type="button" class="md3-button md3-button--icon weight-adjust" 
                                                    data-criteria="{{ criterion }}" data-profile="investment" data-delta="0.05">
                                                <span class="material-symbols-outlined">add</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="md3-form-group">
                                        <div class="md3-progress md3-progress--with-label">
                                            <div class="md3-progress-bar md3-progress-bar--warning" 
                                                 id="investment_progress_{{ criterion }}"
                                                 style="width: {{ (weight * 100)|round }}%"
                                                 data-weight="{{ weight }}">
                                                <span class="md3-progress-label" id="investment_percent_{{ criterion }}">
                                                    {{ (weight * 100)|round(1) }}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <hr class="md3-divider">
                        <div class="md3-card__actions">
                            <button type="submit" class="md3-button md3-button--filled">
                                <span class="material-symbols-outlined">save</span>
                                Update Investment Weights & Rescore
                            </button>
                            <div class="md3-info-container">
                                <div class="md3-progress md3-progress--with-label" style="width: 200px; border: 2px solid #f57c00;">
                                    <div id="investment-weight-bar" class="md3-progress-bar md3-progress-bar--warning" style="width: 100%">
                                        <span id="investment-weight-text" class="md3-progress-label" style="color: black;">100%</span>
                                    </div>
                                </div>
                                <small class="body-small">Investment Profile Total</small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Lifestyle Profile Tab -->
        <div class="md3-tab-content" id="lifestyle" role="tabpanel" aria-labelledby="lifestyle-tab">
            <div class="md3-card md3-card--elevated">
                <div class="md3-card__header">
                    <h2 class="title-large" style="color: #2e7d32;">
                        <span class="material-symbols-outlined">home</span>
                        Lifestyle Profile
                    </h2>
                </div>
                <div class="md3-card__content">
                    <form method="POST" action="{{ url_for('main.update_criteria_profile', profile='lifestyle') }}" id="lifestyle-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        
                        <!-- Lifestyle Profile Criteria -->
                        {% for criterion, weight in lifestyle_weights.items() %}
                            {% if weight > 0 %}
                                <div class="md3-form-row">
                                    <div class="md3-form-group">
                                        <label class="title-medium">
                                            {{ format_field_name(criterion) }}
                                        </label>
                                        <p class="md3-form-helper">{{ criteria_descriptions.get(criterion, 'Custom scoring criterion') }}</p>
                                    </div>
                                    <div class="md3-form-group">
                                        <div class="md3-form-controls">
                                            <button type="button" class="md3-button md3-button--icon weight-adjust" 
                                                    data-criteria="{{ criterion }}" data-profile="lifestyle" data-delta="-0.05">
                                                <span class="material-symbols-outlined">remove</span>
                                            </button>
                                            <div class="md3-slider" style="flex-grow: 1;">
                                                <input type="range" 
                                                       class="md3-slider__input weight-slider" 
                                                       id="lifestyle_slider_{{ criterion }}"
                                                       data-criteria="{{ criterion }}"
                                                       data-profile="lifestyle"
                                                       value="{{ (weight * 100)|round }}"
                                                       min="0" 
                                                       max="100" 
                                                       step="1">
                                            </div>
                                            <div class="md3-text-field md3-number-field">
                                                <input type="number" 
                                                       class="md3-text-field__input weight-input" 
                                                       id="lifestyle_weight_{{ criterion }}"
                                                       name="weight_{{ criterion }}"
                                                       value="{{ weight|round(2) }}"
                                                       min="0" 
                                                       max="1" 
                                                       step="0.01"
                                                       required>
                                            </div>
                                            <button type="button" class="md3-button md3-button--icon weight-adjust" 
                                                    data-criteria="{{ criterion }}" data-profile="lifestyle" data-delta="0.05">
                                                <span class="material-symbols-outlined">add</span>
                                            </button>
                                        </div>
                                    </div>
                                    <div class="md3-form-group">
                                        <div class="md3-progress md3-progress--with-label">
                                            <div class="md3-progress-bar md3-progress-bar--success" 
                                                 id="lifestyle_progress_{{ criterion }}"
                                                 style="width: {{ (weight * 100)|round }}%"
                                                 data-weight="{{ weight }}">
                                                <span class="md3-progress-label" id="lifestyle_percent_{{ criterion }}">
                                                    {{ (weight * 100)|round(1) }}%
                                                </span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                        
                        <hr class="md3-divider">
                        <div class="md3-card__actions">
                            <button type="submit" class="md3-button md3-button--filled">
                                <span class="material-symbols-outlined">save</span>
                                Update Lifestyle Weights & Rescore
                            </button>
                            <div class="md3-info-container">
                                <div class="md3-progress md3-progress--with-label" style="width: 200px; border: 2px solid #2e7d32;">
                                    <div id="lifestyle-weight-bar" class="md3-progress-bar md3-progress-bar--success" style="width: 100%">
                                        <span id="lifestyle-weight-text" class="md3-progress-label">100%</span>
                                    </div>
                                </div>
                                <small class="body-small">Lifestyle Profile Total</small>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Combined Mix Tab -->
        <div class="md3-tab-content" id="combined" role="tabpanel" aria-labelledby="combined-tab">
            <div class="md3-card md3-card--elevated">
                <div class="md3-card__header">
                    <h2 class="title-large">
                        <span class="material-symbols-outlined">balance</span>
                        Combined Mix
                    </h2>
                </div>
                <div class="md3-card__content">
                    <form method="POST" action="{{ url_for('main.update_combined_mix') }}" id="combined-form">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                        <div class="md3-grid md3-grid--2-col">
                            <div class="md3-form-group">
                                <label class="title-medium">
                                    <span class="material-symbols-outlined" style="color: #f57c00;">trending_up</span>
                                    Investment
                                </label>
                                <div class="md3-form-controls">
                                    <div class="md3-slider" style="flex-grow: 1;">
                                        <input type="range" 
                                               class="md3-slider__input" 
                                               id="investment-mix-slider"
                                               min="0" 
                                               max="100" 
                                               value="{{ (combined_mix.investment * 100)|round }}"
                                               step="1">
                                    </div>
                                    <div class="md3-text-field md3-number-field">
                                        <input type="number" 
                                               class="md3-text-field__input" 
                                               id="investment-mix-input"
                                               name="investment_weight"
                                               value="{{ combined_mix.investment|round(2) }}"
                                               min="0" 
                                               max="1" 
                                               step="0.01"
                                               required>
                                    </div>
                                    <span class="title-medium" id="investment-mix-percent">{{ (combined_mix.investment * 100)|round }}%</span>
                                </div>
                                <small class="md3-form-helper">How much the Investment score contributes to the overall score</small>
                            </div>
                            <div class="md3-form-group">
                                <label class="title-medium">
                                    <span class="material-symbols-outlined" style="color: #2e7d32;">home</span>
                                    Lifestyle
                                </label>
                                <div class="md3-form-controls">
                                    <div class="md3-slider" style="flex-grow: 1;">
                                        <input type="range" 
                                               class="md3-slider__input" 
                                               id="lifestyle-mix-slider"
                                               min="0" 
                                               max="100" 
                                               value="{{ (combined_mix.lifestyle * 100)|round }}"
                                               step="1">
                                    </div>
                                    <div class="md3-text-field md3-number-field">
                                        <input type="number" 
                                               class="md3-text-field__input" 
                                               id="lifestyle-mix-input"
                                               name="lifestyle_weight"
                                               value="{{ combined_mix.lifestyle|round(2) }}"
                                               min="0" 
                                               max="1" 
                                               step="0.01"
                                               required>
                                    </div>
                                    <span class="title-medium" id="lifestyle-mix-percent">{{ (combined_mix.lifestyle * 100)|round }}%</span>
                                </div>
                                <small class="md3-form-helper">How much the Lifestyle score contributes to the overall score</small>
                            </div>
                        </div>

                        <!-- Visual representation -->
                        <div class="md3-mb-4">
                            <h3 class="title-medium md3-mb-4">Score Composition Preview:</h3>
                            <div class="md3-progress md3-progress--with-label" style="height: 40px;">
                                <div class="md3-progress-bar md3-progress-bar--warning" 
                                     id="combined-investment-bar"
                                     style="width: 32%; display: flex; align-items: center; justify-content: center;">
                                    <span class="md3-progress-label" style="color: white;">Investment: 32%</span>
                                </div>
                                <div class="md3-progress-bar md3-progress-bar--success" 
                                     id="combined-lifestyle-bar"
                                     style="width: 68%; display: flex; align-items: center; justify-content: center;">
                                    <span class="md3-progress-label" style="color: white;">Lifestyle: 68%</span>
                                </div>
                            </div>
                            <small class="md3-form-helper">Final Score = (Investment Score × 32%) + (Lifestyle Score × 68%)</small>
                        </div>

                        <hr class="md3-divider">
                        <div class="md3-card__actions">
                            <button type="submit" class="md3-button md3-button--filled">
                                <span class="material-symbols-outlined">save</span>
                                Update Combined Mix & Rescore All Properties
                            </button>
                            <div class="md3-info-container">
                                <strong class="body-medium">Current:</strong> 32% Investment + 68% Lifestyle = 100%
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {

    // ============ WEIGHT CONTROL FUNCTIONALITY ============
    
    // Update individual weight and sync all related controls
    function updateWeight(criterion, profile, newWeight, source = 'manual') {
        const weightInput = document.getElementById(`${profile}_weight_${criterion}`);
        const slider = document.getElementById(`${profile}_slider_${criterion}`);
        const progressBar = document.getElementById(`${profile}_progress_${criterion}`);
        const percentSpan = document.getElementById(`${profile}_percent_${criterion}`);

        // Ensure weight is within bounds
        newWeight = Math.max(0, Math.min(1, newWeight));
        
        // Update all related controls
        if (weightInput) weightInput.value = newWeight.toFixed(2);
        if (slider) slider.value = Math.round(newWeight * 100);
        if (progressBar) {
            progressBar.style.width = Math.round(newWeight * 100) + '%';
            progressBar.setAttribute('data-weight', newWeight);
        }
        if (percentSpan) percentSpan.textContent = (newWeight * 100).toFixed(1) + '%';

        // Update total weight for the profile
        updateTotalWeight(profile);
        
        // Validate form
        validateForm(profile);
    }

    // Calculate and update total weight for a profile
    function updateTotalWeight(profile) {
        const weightInputs = document.querySelectorAll(`#${profile}-form .weight-input`);
        let totalWeight = 0;
        
        weightInputs.forEach(input => {
            totalWeight += parseFloat(input.value) || 0;
        });

        // Update total weight display
        const totalWeightBar = document.getElementById(`${profile}-weight-bar`);
        const totalWeightText = document.getElementById(`${profile}-weight-text`);
        
        if (totalWeightBar && totalWeightText) {
            const percentage = Math.round(totalWeight * 100);
            totalWeightBar.style.width = Math.min(100, percentage) + '%';
            totalWeightText.textContent = percentage + '%';
            
            // Color coding based on how close to 100%
            totalWeightBar.className = `md3-progress-bar ${profile === 'investment' ? 'md3-progress-bar--warning' : 'md3-progress-bar--success'}`;
            if (Math.abs(totalWeight - 1.0) > 0.01) {
                totalWeightText.style.color = '#d32f2f'; // Error color
            } else {
                totalWeightText.style.color = 'black';
            }
        }
        
        return totalWeight;
    }

    // Form validation
    function validateForm(profile) {
        const form = document.getElementById(`${profile}-form`);
        const submitButton = form ? form.querySelector('button[type="submit"]') : null;
        
        if (!submitButton) return;
        
        const totalWeight = updateTotalWeight(profile);
        const isValid = Math.abs(totalWeight - 1.0) <= 0.01;
        
        submitButton.disabled = !isValid;
        if (isValid) {
            submitButton.classList.remove('md3-button--disabled');
        } else {
            submitButton.classList.add('md3-button--disabled');
        }
    }

    // ============ EVENT LISTENERS FOR WEIGHT CONTROLS ============
    
    // Weight adjustment buttons (+/-)
    document.querySelectorAll('.weight-adjust').forEach(button => {
        button.addEventListener('click', function() {
            const criterion = this.getAttribute('data-criteria');
            const profile = this.getAttribute('data-profile');
            const delta = parseFloat(this.getAttribute('data-delta'));
            
            const weightInput = document.getElementById(`${profile}_weight_${criterion}`);
            if (weightInput) {
                const currentWeight = parseFloat(weightInput.value) || 0;
                updateWeight(criterion, profile, currentWeight + delta, 'button');
            }
        });
    });

    // Slider inputs
    document.querySelectorAll('.weight-slider').forEach(slider => {
        slider.addEventListener('input', function() {
            const criterion = this.getAttribute('data-criteria');
            const profile = this.getAttribute('data-profile');
            const newWeight = parseFloat(this.value) / 100;
            
            updateWeight(criterion, profile, newWeight, 'slider');
        });
    });

    // Number inputs
    document.querySelectorAll('.weight-input').forEach(input => {
        input.addEventListener('input', function() {
            const criterion = this.id.replace(`${this.closest('form').id.replace('-form', '')}_weight_`, '');
            const profile = this.closest('form').id.replace('-form', '');
            const newWeight = parseFloat(this.value) || 0;
            
            updateWeight(criterion, profile, newWeight, 'input');
        });

        // Prevent invalid input
        input.addEventListener('keydown', function(e) {
            // Allow navigation keys, backspace, delete, tab, escape, enter
            if ([46, 8, 9, 27, 13].indexOf(e.keyCode) !== -1 ||
                // Allow Ctrl+A, Ctrl+C, Ctrl+V, Ctrl+X
                (e.keyCode === 65 && e.ctrlKey === true) ||
                (e.keyCode === 67 && e.ctrlKey === true) ||
                (e.keyCode === 86 && e.ctrlKey === true) ||
                (e.keyCode === 88 && e.ctrlKey === true) ||
                // Allow home, end, left, right
                (e.keyCode >= 35 && e.keyCode <= 39)) {
                return;
            }
            // Ensure that it is a number or decimal point
            if ((e.shiftKey || (e.keyCode < 48 || e.keyCode > 57)) && 
                (e.keyCode < 96 || e.keyCode > 105) && 
                e.keyCode !== 190 && e.keyCode !== 110) {
                e.preventDefault();
            }
        });
    });

    // ============ COMBINED MIX FUNCTIONALITY ============
    
    // Combined mix sliders
    const investmentMixSlider = document.getElementById('investment-mix-slider');
    const lifestyleMixSlider = document.getElementById('lifestyle-mix-slider');
    const investmentMixInput = document.getElementById('investment-mix-input');
    const lifestyleMixInput = document.getElementById('lifestyle-mix-input');

    function updateCombinedMix() {
        if (!investmentMixSlider || !lifestyleMixSlider) return;
        
        const investmentValue = parseFloat(investmentMixSlider.value) / 100;
        const lifestyleValue = 1 - investmentValue; // Ensure they sum to 1
        
        // Update all controls
        investmentMixInput.value = investmentValue.toFixed(2);
        lifestyleMixInput.value = lifestyleValue.toFixed(2);
        lifestyleMixSlider.value = Math.round(lifestyleValue * 100);
        
        // Update percentage displays
        const investmentPercent = document.getElementById('investment-mix-percent');
        const lifestylePercent = document.getElementById('lifestyle-mix-percent');
        if (investmentPercent) investmentPercent.textContent = Math.round(investmentValue * 100) + '%';
        if (lifestylePercent) lifestylePercent.textContent = Math.round(lifestyleValue * 100) + '%';
        
        // Update visual bars
        const investmentBar = document.getElementById('combined-investment-bar');
        const lifestyleBar = document.getElementById('combined-lifestyle-bar');
        if (investmentBar && lifestyleBar) {
            const invPercent = Math.round(investmentValue * 100);
            const lifePercent = 100 - invPercent;
            
            investmentBar.style.width = invPercent + '%';
            lifestyleBar.style.width = lifePercent + '%';
            
            investmentBar.querySelector('.md3-progress-label').textContent = `Investment: ${invPercent}%`;
            lifestyleBar.querySelector('.md3-progress-label').textContent = `Lifestyle: ${lifePercent}%`;
        }
    }

    if (investmentMixSlider) {
        investmentMixSlider.addEventListener('input', updateCombinedMix);
    }
    
    if (lifestyleMixSlider) {
        lifestyleMixSlider.addEventListener('input', function() {
            const lifestyleValue = parseFloat(this.value) / 100;
            const investmentValue = 1 - lifestyleValue;
            investmentMixSlider.value = Math.round(investmentValue * 100);
            updateCombinedMix();
        });
    }

    // Number input sync for combined mix
    if (investmentMixInput) {
        investmentMixInput.addEventListener('input', function() {
            const investmentValue = Math.max(0, Math.min(1, parseFloat(this.value) || 0));
            investmentMixSlider.value = Math.round(investmentValue * 100);
            updateCombinedMix();
        });
    }

    if (lifestyleMixInput) {
        lifestyleMixInput.addEventListener('input', function() {
            const lifestyleValue = Math.max(0, Math.min(1, parseFloat(this.value) || 0));
            lifestyleMixSlider.value = Math.round(lifestyleValue * 100);
            updateCombinedMix();
        });
    }

    // ============ FORM SUBMISSION HANDLING ============
    
    document.querySelectorAll('form[id$="-form"]').forEach(form => {
        form.addEventListener('submit', function(e) {
            const profile = this.id.replace('-form', '');
            const totalWeight = updateTotalWeight(profile);
            
            // Final validation before submit
            if (Math.abs(totalWeight - 1.0) > 0.01) {
                e.preventDefault();
                alert(`Error: Total weights must equal 100% (currently ${(totalWeight * 100).toFixed(1)}%)`);
                return false;
            }
            
            // Show loading state
            const submitButton = this.querySelector('button[type="submit"]');
            if (submitButton) {
                const originalText = submitButton.textContent;
                submitButton.disabled = true;
                submitButton.innerHTML = '<span class="material-symbols-outlined md3-spinner">refresh</span> Updating...';
                
                // Re-enable after timeout (fallback)
                setTimeout(() => {
                    submitButton.disabled = false;
                    submitButton.innerHTML = originalText;
                }, 30000);
            }
        });
    });

    // ============ INITIALIZATION ============
    
    // Initialize all forms
    ['investment', 'lifestyle'].forEach(profile => {
        updateTotalWeight(profile);
        validateForm(profile);
    });
    
    // Initialize combined mix
    updateCombinedMix();
    
    console.log('Criteria form functionality initialized successfully');
        const weightInputs = document.querySelectorAll(`input[name^="weight_"]`);
        let total = 0;
        
        weightInputs.forEach(input => {
            if (input.id.includes(profile)) {
                total += parseFloat(input.value) || 0;
            }
        });

        const weightBar = document.getElementById(`${profile}-weight-bar`);
        const weightText = document.getElementById(`${profile}-weight-text`);
        
        if (weightBar && weightText) {
            const percentage = Math.round(total * 100);
            weightBar.style.width = percentage + '%';
            weightText.textContent = percentage + '%';
        }
    }

    // Slider sync functionality
    document.querySelectorAll('.weight-slider').forEach(slider => {
        slider.addEventListener('input', function() {
            const criterion = this.dataset.criteria;
            const profile = this.dataset.profile;
            const weightInput = document.getElementById(`${profile}_weight_${criterion}`);
            const progressBar = document.getElementById(`${profile}_progress_${criterion}`);
            const percentSpan = document.getElementById(`${profile}_percent_${criterion}`);
            
            const value = parseFloat(this.value) / 100;
            weightInput.value = value.toFixed(2);
            progressBar.style.width = this.value + '%';
            percentSpan.textContent = parseFloat(this.value).toFixed(1) + '%';
            
            updateTotalWeight(profile);
        });
    });

    // Weight input sync functionality
    document.querySelectorAll('.weight-input').forEach(input => {
        input.addEventListener('input', function() {
            const criterion = this.id.split('_')[1] + '_' + this.id.split('_')[2];
            const profile = this.id.split('_')[0];
            const slider = document.getElementById(`${profile}_slider_${criterion}`);
            const progressBar = document.getElementById(`${profile}_progress_${criterion}`);
            const percentSpan = document.getElementById(`${profile}_percent_${criterion}`);
            
            const value = Math.max(0, Math.min(1, parseFloat(this.value)));
            this.value = value.toFixed(2);
            slider.value = Math.round(value * 100);
            progressBar.style.width = Math.round(value * 100) + '%';
            percentSpan.textContent = (value * 100).toFixed(1) + '%';
            
            updateTotalWeight(profile);
        });
    });

    // Weight adjustment buttons
    document.querySelectorAll('.weight-adjust').forEach(button => {
        button.addEventListener('click', function() {
            const criterion = this.dataset.criteria;
            const profile = this.dataset.profile;
            const delta = parseFloat(this.dataset.delta);
            updateWeight(criterion, profile, delta);
        });
    });

    // Combined mix sliders
    const investmentMixSlider = document.getElementById('investment-mix-slider');
    const lifestyleMixSlider = document.getElementById('lifestyle-mix-slider');
    const investmentMixInput = document.getElementById('investment-mix-input');
    const lifestyleMixInput = document.getElementById('lifestyle-mix-input');
    const investmentMixPercent = document.getElementById('investment-mix-percent');
    const lifestyleMixPercent = document.getElementById('lifestyle-mix-percent');

    if (investmentMixSlider) {
        investmentMixSlider.addEventListener('input', function() {
            const investmentValue = parseFloat(this.value) / 100;
            const lifestyleValue = 1 - investmentValue;
            
            investmentMixInput.value = investmentValue.toFixed(2);
            lifestyleMixInput.value = lifestyleValue.toFixed(2);
            investmentMixPercent.textContent = Math.round(investmentValue * 100) + '%';
            lifestyleMixPercent.textContent = Math.round(lifestyleValue * 100) + '%';
            lifestyleMixSlider.value = Math.round(lifestyleValue * 100);
            
            updateCombinedPreview();
        });
    }

    if (lifestyleMixSlider) {
        lifestyleMixSlider.addEventListener('input', function() {
            const lifestyleValue = parseFloat(this.value) / 100;
            const investmentValue = 1 - lifestyleValue;
            
            lifestyleMixInput.value = lifestyleValue.toFixed(2);
            investmentMixInput.value = investmentValue.toFixed(2);
            lifestyleMixPercent.textContent = Math.round(lifestyleValue * 100) + '%';
            investmentMixPercent.textContent = Math.round(investmentValue * 100) + '%';
            investmentMixSlider.value = Math.round(investmentValue * 100);
            
            updateCombinedPreview();
        });
    }

    function updateCombinedPreview() {
        const investmentBar = document.getElementById('combined-investment-bar');
        const lifestyleBar = document.getElementById('combined-lifestyle-bar');
        
        if (investmentBar && lifestyleBar) {
            const investmentPercent = Math.round(parseFloat(investmentMixInput.value) * 100);
            const lifestylePercent = Math.round(parseFloat(lifestyleMixInput.value) * 100);
            
            investmentBar.style.width = investmentPercent + '%';
            lifestyleBar.style.width = lifestylePercent + '%';
            investmentBar.querySelector('.md3-progress-label').textContent = `Investment: ${investmentPercent}%`;
            lifestyleBar.querySelector('.md3-progress-label').textContent = `Lifestyle: ${lifestylePercent}%`;
        }
    }

    // Initialize total weights on page load
    updateTotalWeight('investment');
    updateTotalWeight('lifestyle');
});
</script>
{% endblock %}