{% extends "base.html" %}

{% block title %}Properties - Idealista Land Watch{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-map-marked-alt me-2"></i>
                Properties
                {% if pagination %}
                    <span class="badge bg-secondary">{{ pagination.total }}</span>
                {% else %}
                    <span class="badge bg-secondary">{{ lands|length }}</span>
                {% endif %}
            </h1>
            
            <div>
                <a href="{{ url_for('main.export_csv', sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}" class="btn btn-success">
                    <i class="fas fa-download me-1"></i>Export CSV
                </a>
            </div>
        </div>

        <!-- Filters -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0">
                    <i class="fas fa-filter me-2"></i>Filters & Search
                </h5>
            </div>
            <div class="card-body">
                <form method="GET" id="filter-form">
                    <div class="row">
                        <!-- Search -->
                        <div class="col-md-3 mb-3">
                            <label for="search" class="form-label">Search</label>
                            <input type="text" class="form-control" id="search" name="search" 
                                   value="{{ current_filters.search or '' }}" 
                                   placeholder="Title, description, municipality...">
                        </div>
                        
                        <!-- Land Type -->
                        <div class="col-md-2 mb-3">
                            <label for="land_type" class="form-label">Land Type</label>
                            <select class="form-select" id="land_type" name="land_type">
                                <option value="">All Types</option>
                                <option value="developed" {{ 'selected' if current_filters.land_type == 'developed' }}>
                                    Developed
                                </option>
                                <option value="buildable" {{ 'selected' if current_filters.land_type == 'buildable' }}>
                                    Buildable
                                </option>
                            </select>
                        </div>
                        
                        <!-- Municipality -->
                        <div class="col-md-2 mb-3">
                            <label for="municipality" class="form-label">Municipality</label>
                            <select class="form-select" id="municipality" name="municipality">
                                <option value="">All Municipalities</option>
                                {% for municipality in municipalities %}
                                    <option value="{{ municipality }}" 
                                            {{ 'selected' if current_filters.municipality == municipality }}>
                                        {{ municipality }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Sea View Filter -->
                        <div class="col-md-2 mb-3">
                            <label class="form-label">&nbsp;</label>
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="sea_view" name="sea_view" 
                                       {{ 'checked' if current_filters.sea_view }}>
                                <label class="form-check-label" for="sea_view">
                                    <i class="fas fa-water me-1"></i>Sea View Only
                                </label>
                            </div>
                        </div>
                        
                        <!-- Sort -->
                        <div class="col-md-3 mb-3">
                            <label for="sort" class="form-label">Sort By</label>
                            <div class="input-group">
                                <select class="form-select" id="sort" name="sort">
                                    <option value="score_total" {{ 'selected' if current_filters.sort_by == 'score_total' }}>
                                        Score Total
                                    </option>
                                    <option value="price" {{ 'selected' if current_filters.sort_by == 'price' }}>
                                        Price
                                    </option>
                                    <option value="area" {{ 'selected' if current_filters.sort_by == 'area' }}>
                                        Area
                                    </option>
                                    <option value="travel_time_nearest_beach" {{ 'selected' if current_filters.sort_by == 'travel_time_nearest_beach' }}>
                                        Beach Distance
                                    </option>
                                    <option value="created_at" {{ 'selected' if current_filters.sort_by == 'created_at' }}>
                                        Date Added
                                    </option>
                                </select>
                                <select class="form-select" name="order" style="max-width: 100px;">
                                    <option value="desc" {{ 'selected' if current_filters.order == 'desc' }}>↓</option>
                                    <option value="asc" {{ 'selected' if current_filters.order == 'asc' }}>↑</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Action Buttons and View Toggle -->
                        <div class="col-md-4 mb-3 d-flex align-items-end">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>Apply
                            </button>
                            <a href="{{ url_for('main.lands') }}" class="btn btn-outline-secondary me-3">
                                <i class="fas fa-times me-1"></i>Clear
                            </a>
                            
                            <!-- View Toggle -->
                            <div class="btn-group" role="group" aria-label="View type">
                                <input type="radio" class="btn-check" name="view_type" id="view_list" value="list" 
                                       {{ 'checked' if current_filters.view_type == 'list' else '' }}>
                                <label class="btn btn-outline-secondary" for="view_list" title="List view">
                                    <i class="fas fa-list"></i>
                                </label>
                                
                                <input type="radio" class="btn-check" name="view_type" id="view_cards" value="cards" 
                                       {{ 'checked' if current_filters.view_type == 'cards' or not current_filters.view_type else '' }}>
                                <label class="btn btn-outline-secondary" for="view_cards" title="Card view">
                                    <i class="fas fa-th-large"></i>
                                </label>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
        </div>

        <!-- Properties Cards -->
        {% if lands %}
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ pagination.total }} properties found</strong>
                    {% if filters_applied %}
                        <span class="text-muted">(filtered)</span>
                    {% endif %}
                </div>
                <div>
                    <a href="{{ url_for('main.export_csv') }}" class="btn btn-success btn-sm">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </a>
                </div>
            </div>
            
            <!-- Properties Grid -->
            <div class="row" id="properties-grid">
                {% for land in lands %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card h-100 property-card" data-land-id="{{ land.id }}">
                            <!-- Card Header with Score and AI Indicator -->
                            <div class="card-header d-flex justify-content-between align-items-center bg-dark text-white">
                                <div class="d-flex align-items-center">
                                    {% if land.score_total %}
                                        <span class="badge score-badge me-2" 
                                              style="background-color: {{ 'var(--bs-success)' if land.score_total >= 70 else 'var(--bs-warning)' if land.score_total >= 50 else 'var(--bs-danger)' }}">
                                            {{ "%.1f"|format(land.score_total) }}
                                        </span>
                                    {% endif %}
                                    <span class="badge {{ 'bg-success' if land.land_type == 'developed' else 'bg-warning' }}">
                                        {{ land.land_type.title() if land.land_type else 'Unknown' }}
                                    </span>
                                </div>
                                <div class="d-flex align-items-center">
                                    {% if land.ai_analysis %}
                                        <i class="fas fa-brain text-info me-2" title="AI Analysis Available"></i>
                                    {% endif %}
                                    <small>{{ land.created_at.strftime('%d %b %y') if land.created_at else '-' }}</small>
                                </div>
                            </div>
                            
                            <!-- Card Body -->
                            <div class="card-body">
                                <h6 class="card-title">{{ land.title[:80] }}{% if land.title|length > 80 %}...{% endif %}</h6>
                                
                                <!-- Price and Area -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        <strong class="text-success">
                                            {% if land.price %}
                                                €{{ "{:,.0f}".format(land.price) }}
                                            {% else %}
                                                <span class="text-muted">Price N/A</span>
                                            {% endif %}
                                        </strong>
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">
                                            {% if land.area %}
                                                {{ "{:,.0f}".format(land.area) }} m²
                                            {% else %}
                                                Area N/A
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Location -->
                                <div class="mb-3">
                                    {% if land.location_lat and land.location_lon %}
                                        <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}" 
                                           target="_blank" class="text-decoration-none d-flex align-items-center">
                                            {% if land.location_accuracy == 'precise' %}
                                                <i class="fas fa-map-marker-alt me-2 text-success"></i>
                                            {% elif land.location_accuracy == 'approximate' %}
                                                <i class="fas fa-map-marker-alt me-2 text-warning"></i>
                                            {% else %}
                                                <i class="fas fa-question-circle me-2 text-secondary"></i>
                                            {% endif %}
                                            <small>{{ land.municipality or 'Unknown location' }}</small>
                                        </a>
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-map-marker-slash me-2"></i>
                                            <small>{{ land.municipality or 'Location unknown' }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Travel Times -->
                                <div class="row mb-3">
                                    {% if land.travel_time_nearest_beach %}
                                        <div class="col-12 mb-2">
                                            <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/{{ land.nearest_beach_name if land.nearest_beach_name else 'Playa' }},+Asturias,+Spain" 
                                               target="_blank" class="text-decoration-none d-flex align-items-center">
                                                <i class="fas fa-umbrella-beach me-2 text-info"></i>
                                                <span class="fw-bold">{{ land.travel_time_nearest_beach }}min</span>
                                                <small class="text-muted ms-2">to beach</small>
                                            </a>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-3">
                                            {% if land.travel_time_oviedo %}
                                                <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Oviedo,+Asturias,+Spain" 
                                                   target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-car me-1 text-primary"></i>
                                                    <span class="fw-bold">{{ land.travel_time_oviedo }}min</span>
                                                    <small class="text-muted">OV</small>
                                                </a>
                                            {% endif %}
                                            {% if land.travel_time_gijon %}
                                                <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Gijón,+Asturias,+Spain" 
                                                   target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-car me-1 text-primary"></i>
                                                    <span class="fw-bold">{{ land.travel_time_gijon }}min</span>
                                                    <small class="text-muted">GJ</small>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- AI Analysis Section (Hidden by default) -->
                                <div id="ai-analysis-{{ land.id }}" class="ai-analysis-section" style="display: none;">
                                    <div class="card bg-light mt-3">
                                        <div class="card-body p-3">
                                            <div id="ai-content-{{ land.id }}" class="ai-content">
                                                <!-- AI analysis content will be loaded here -->
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Footer with Actions -->
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <div>
                                    {% if land.url %}
                                        <a href="{{ land.url }}" target="_blank" 
                                           class="btn btn-success btn-sm" title="View on Idealista">
                                            <i class="fas fa-home me-1"></i>
                                            Idealista
                                        </a>
                                    {% endif %}
                                </div>
                                <div>
                                    <button onclick="toggleAIAnalysis({{ land.id }})" 
                                            class="btn btn-outline-primary btn-sm ai-analyze-btn"
                                            data-land-id="{{ land.id }}">
                                        {% if land.ai_analysis %}
                                            <i class="fas fa-eye"></i> View AI Analysis
                                        {% else %}
                                            <i class="fas fa-brain"></i> AI Analysis
                                        {% endif %}
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
            </div>
                
                <!-- Pagination -->
                {% if pagination and pagination.total > 0 %}
                <div class="card-footer">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <span class="text-muted">
                                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - 
                                {{ (pagination.page * pagination.per_page) if (pagination.page * pagination.per_page) < pagination.total else pagination.total }} 
                                of {{ pagination.total }} results
                            </span>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="d-inline-flex align-items-center">
                                <span class="text-muted me-2 small">Show:</span>
                                <select class="form-select form-select-sm" style="width: auto;" 
                                        onchange="window.location.href=updateUrlParameter(window.location.href, 'per_page', this.value)">
                                    <option value="10" {{ 'selected' if current_filters.per_page == 10 }}>10</option>
                                    <option value="25" {{ 'selected' if current_filters.per_page == 25 }}>25</option>
                                    <option value="50" {{ 'selected' if current_filters.per_page == 50 }}>50</option>
                                    <option value="100" {{ 'selected' if current_filters.per_page == 100 }}>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if pagination.pages > 1 %}
                            <nav aria-label="Page navigation">
                                <ul class="pagination pagination-sm mb-0 justify-content-end">
                                    <!-- Previous page -->
                                    {% if pagination.has_prev %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main.lands', page=pagination.prev_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    <!-- Page numbers -->
                                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                        {% if page_num %}
                                            {% if page_num != pagination.page %}
                                                <li class="page-item">
                                                    <a class="page-link" href="{{ url_for('main.lands', page=page_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}">
                                                        {{ page_num }}
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ page_num }}</span>
                                                </li>
                                            {% endif %}
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">…</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Next page -->
                                    {% if pagination.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main.lands', page=pagination.next_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No properties found</h4>
                <p class="text-muted">Try adjusting your filters or run a manual sync to fetch new data.</p>
                <button class="btn btn-primary" 
                        hx-post="{{ url_for('api.manual_ingestion') }}"
                        hx-trigger="click"
                        hx-indicator="#ingestion-spinner">
                    <i class="fas fa-sync-alt me-1"></i>
                    Run Manual Sync
                </button>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-submit form on filter changes (debounced)
let filterTimeout;
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const inputs = form.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                if (input.name !== 'search') {
                    form.submit();
                }
            }, 300);
        });
        
        if (input.name === 'search') {
            input.addEventListener('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    form.submit();
                }, 1000);
            });
        }
    });
});

// HTMX event listeners
document.addEventListener('htmx:responseError', function(evt) {
    alert('Error: ' + evt.detail.xhr.responseText);
});

document.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        // Reload page after successful ingestion
        if (evt.detail.xhr.response) {
            const response = JSON.parse(evt.detail.xhr.response);
            if (response.success) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }
    }
});

// AI Analysis Management
async function toggleAIAnalysis(landId) {
    const analysisSection = document.getElementById(`ai-analysis-${landId}`);
    const button = document.querySelector(`[data-land-id="${landId}"]`);
    const content = document.getElementById(`ai-content-${landId}`);
    
    if (analysisSection.style.display === 'none') {
        // Show analysis section
        analysisSection.style.display = 'block';
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Loading...';
        button.disabled = true;
        
        // Load AI analysis if not already loaded
        if (!content.innerHTML.trim()) {
            await loadAIAnalysis(landId);
        }
        
        button.innerHTML = '<i class="fas fa-eye-slash"></i> Hide Analysis';
        button.disabled = false;
    } else {
        // Hide analysis section
        analysisSection.style.display = 'none';
        button.innerHTML = button.innerHTML.includes('View AI Analysis') ? 
            '<i class="fas fa-eye"></i> View AI Analysis' : 
            '<i class="fas fa-brain"></i> AI Analysis';
    }
}

async function loadAIAnalysis(landId) {
    try {
        const response = await fetch(`/api/analyze/property/${landId}/structured`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });
        
        const data = await response.json();
        
        if (data.success && data.analysis) {
            renderAIAnalysis(landId, data.analysis);
        } else {
            showAIError(landId, data.error || 'Analysis failed');
        }
    } catch (error) {
        console.error('AI Analysis Error:', error);
        showAIError(landId, 'Failed to load AI analysis');
    }
}

function renderAIAnalysis(landId, analysis) {
    const content = document.getElementById(`ai-content-${landId}`);
    
    const html = `
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="ai-section border rounded p-3 h-100">
                    <h6 class="ai-section-title">
                        <i class="fas fa-euro-sign text-success"></i> Price Analysis
                    </h6>
                    <div class="ai-content">
                        <span class="badge ${getPriceVerdictClass(analysis.price_analysis?.verdict)}">
                            ${analysis.price_analysis?.verdict || 'Unknown'}
                        </span>
                        <p class="mb-1 mt-2">${analysis.price_analysis?.summary || 'No analysis available'}</p>
                        <small class="text-muted">${analysis.price_analysis?.recommendation || ''}</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="ai-section border rounded p-3 h-100">
                    <h6 class="ai-section-title">
                        <i class="fas fa-chart-line text-primary"></i> Investment Potential
                    </h6>
                    <div class="ai-content">
                        <span class="badge ${getInvestmentRatingClass(analysis.investment_potential?.rating)}">
                            ${analysis.investment_potential?.rating || 'Unknown'} Growth
                        </span>
                        <p class="mb-1 mt-2">${analysis.investment_potential?.forecast || 'No forecast available'}</p>
                        <small class="text-muted">Risk: ${analysis.investment_potential?.risk_level || 'Unknown'}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-md-6 mb-3">
                <div class="ai-section border rounded p-3 h-100">
                    <h6 class="ai-section-title">
                        <i class="fas fa-exclamation-triangle text-warning"></i> Risks & Advantages
                    </h6>
                    <div class="ai-content">
                        ${renderListItems(analysis.risks_analysis?.major_risks, 'Risks:', 'danger')}
                        ${renderListItems(analysis.risks_analysis?.advantages, 'Advantages:', 'success')}
                        <small class="text-muted">${analysis.risks_analysis?.mitigation || ''}</small>
                    </div>
                </div>
            </div>
            
            <div class="col-md-6 mb-3">
                <div class="ai-section border rounded p-3 h-100">
                    <h6 class="ai-section-title">
                        <i class="fas fa-hammer text-info"></i> Development Ideas
                    </h6>
                    <div class="ai-content">
                        <p class="mb-1"><strong>${analysis.development_ideas?.best_use || 'No recommendations'}</strong></p>
                        <p class="mb-1">${analysis.development_ideas?.building_size || ''}</p>
                        <small class="text-muted">${analysis.development_ideas?.estimated_cost || ''}</small>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="row">
            <div class="col-12">
                <div class="ai-section border rounded p-3">
                    <h6 class="ai-section-title">
                        <i class="fas fa-balance-scale text-secondary"></i> Market Comparison
                    </h6>
                    <div class="ai-content">
                        <p class="mb-1">${analysis.comparable_analysis?.market_position || 'No comparison data'}</p>
                        ${renderListItems(analysis.comparable_analysis?.advantages_vs_similar, 'Better than similar:', 'success')}
                        ${renderListItems(analysis.comparable_analysis?.disadvantages_vs_similar, 'Worse than similar:', 'danger')}
                    </div>
                </div>
            </div>
        </div>
    `;
    
    content.innerHTML = html;
}

function renderListItems(items, label, colorClass) {
    if (!items || !Array.isArray(items) || items.length === 0) return '';
    
    const listItems = items.map(item => 
        `<li><i class="fas fa-dot-circle text-${colorClass} me-1"></i>${item}</li>`
    ).join('');
    
    return `<div class="mb-2"><strong>${label}</strong><ul class="list-unstyled mb-1">${listItems}</ul></div>`;
}

function getPriceVerdictClass(verdict) {
    switch(verdict) {
        case 'FAIR_PRICE': return 'bg-success';
        case 'UNDERPRICED': return 'bg-primary';
        case 'OVERPRICED': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getInvestmentRatingClass(rating) {
    switch(rating) {
        case 'HIGH': return 'bg-success';
        case 'MEDIUM': return 'bg-warning';
        case 'LOW': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function showAIError(landId, error) {
    const content = document.getElementById(`ai-content-${landId}`);
    content.innerHTML = `
        <div class="alert alert-danger">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Analysis Error:</strong> ${error}
        </div>
    `;
}
</script>
{% endblock %}
