{% extends "base.html" %}

{% block title %}Properties - Idealista Land Watch{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1>
                <i class="fas fa-map-marked-alt me-2"></i>
                {{ t('properties') }}
                {% if pagination %}
                    <span class="chip chip-secondary">{{ pagination.total }}</span>
                {% else %}
                    <span class="chip chip-secondary">{{ lands|length }}</span>
                {% endif %}
                <small class="text-muted ms-3 fw-normal" style="font-size: 0.75rem;">
                    {{ t('last_sync') }}: <span id="last-sync">{{ t('loading') }}...</span>
                </small>
            </h1>
            
            <div>
                <a href="{{ url_for('main.export_csv', mode=current_filters.mode, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}" class="btn-filled">
                    <i class="fas fa-download me-1"></i>{{ t('export_csv') }}
                </a>
            </div>
        </div>


        <!-- Filters -->
        <div class="card-elevated" style="margin-bottom: var(--md-sys-spacing-8);">
            <div class="card-header">
                <h5 class="title-medium" style="margin-bottom: 0; color: var(--md-sys-color-on-surface);">
                    <i class="fas fa-filter" style="margin-right: var(--md-sys-spacing-2); color: var(--md-sys-color-primary);"></i>{{ t('filters_search') }}
                </h5>
            </div>
            <div style="padding: var(--md-sys-spacing-6);">
                <form method="GET" id="filter-form">
                    <!-- Hidden inputs to preserve state -->
                    <input type="hidden" name="mode" value="{{ current_filters.mode or 'combined' }}">
                    <input type="hidden" name="view_type" value="{{ current_filters.view_type or 'cards' }}">
                    <div class="form-grid" style="display: flex; gap: var(--md-sys-spacing-3); margin-bottom: var(--md-sys-spacing-6); align-items: center; flex-wrap: nowrap;">
                        <!-- Search -->
                        <div class="form-field" style="flex: 1; min-width: 150px;">
                            <input type="text" class="form-input body-large" id="search" name="search" 
                                   value="{{ current_filters.search or '' }}" 
                                   placeholder="{{ t('search_properties') }}">
                        </div>
                        
                        <!-- Land Type -->
                        <div class="form-field" style="flex: 0.8; min-width: 120px;">
                            <select class="md-select body-large" id="land_type" name="land_type">
                                <option value="">{{ t('land_type_all') }}</option>
                                <option value="developed" {{ 'selected' if current_filters.land_type == 'developed' }}>
                                    {{ t('developed') }}
                                </option>
                                <option value="buildable" {{ 'selected' if current_filters.land_type == 'buildable' }}>
                                    {{ t('buildable') }}
                                </option>
                            </select>
                        </div>
                        
                        <!-- Municipality -->
                        <div class="form-field" style="flex: 0.8; min-width: 140px;">
                            <select class="md-select body-large" id="municipality" name="municipality">
                                <option value="">{{ t('all_municipalities') }}</option>
                                {% for municipality in municipalities %}
                                    <option value="{{ municipality }}" 
                                            {{ 'selected' if current_filters.municipality == municipality }}>
                                        {{ municipality }}
                                    </option>
                                {% endfor %}
                            </select>
                        </div>
                        
                        <!-- Sea View Filter -->
                        <div class="form-field" style="display: flex; align-items: center; height: 40px; flex: 0 0 auto;">
                            <input class="form-input" type="checkbox" id="sea_view" name="sea_view" 
                                   {{ 'checked' if current_filters.sea_view }}
                                   style="width: 18px; height: 18px; margin-right: var(--md-sys-spacing-2); accent-color: var(--md-sys-color-primary);">
                            <label class="form-check-label label-medium" for="sea_view" style="color: var(--md-sys-color-on-surface); cursor: pointer;">
                                <i class="fas fa-water" style="margin-right: var(--md-sys-spacing-1); color: var(--md-sys-color-primary);"></i>{{ t('sea_view_only') }}
                            </label>
                        </div>
                        
                        <!-- Sort -->
                        <div class="form-field" style="flex: 1; min-width: 150px;">
                            <div style="display: flex; gap: var(--md-sys-spacing-2);">
                                <select class="md-select body-large" id="sort" name="sort" style="flex: 1;">
                                    <option value="" {{ 'selected' if not current_filters.sort_by else '' }}>{{ t('sort_by') }}</option>
                                    <!-- Mode-based score options -->
                                    {% if current_filters.mode == 'investment' %}
                                        <option value="score_investment" {{ 'selected' if current_filters.sort_by == 'score_investment' }}>
                                            üíº Investment Score
                                        </option>
                                        <option value="score_lifestyle" {{ 'selected' if current_filters.sort_by == 'score_lifestyle' }}>
                                            üè° Lifestyle Score
                                        </option>
                                        <option value="score_total" {{ 'selected' if current_filters.sort_by == 'score_total' }}>
                                            Combined Score
                                        </option>
                                    {% elif current_filters.mode == 'lifestyle' %}
                                        <option value="score_lifestyle" {{ 'selected' if current_filters.sort_by == 'score_lifestyle' }}>
                                            üè° Lifestyle Score
                                        </option>
                                        <option value="score_investment" {{ 'selected' if current_filters.sort_by == 'score_investment' }}>
                                            üíº Investment Score
                                        </option>
                                        <option value="score_total" {{ 'selected' if current_filters.sort_by == 'score_total' }}>
                                            Combined Score
                                        </option>
                                    {% else %}
                                        <option value="score_total" {{ 'selected' if current_filters.sort_by == 'score_total' }}>
                                            Combined Score
                                        </option>
                                        <option value="score_investment" {{ 'selected' if current_filters.sort_by == 'score_investment' }}>
                                            üíº Investment Score
                                        </option>
                                        <option value="score_lifestyle" {{ 'selected' if current_filters.sort_by == 'score_lifestyle' }}>
                                            üè° Lifestyle Score
                                        </option>
                                    {% endif %}
                                    <!-- Other sort options -->
                                    <option value="price" {{ 'selected' if current_filters.sort_by == 'price' }}>
                                        {{ t('price') }}
                                    </option>
                                    <option value="area" {{ 'selected' if current_filters.sort_by == 'area' }}>
                                        {{ t('area') }}
                                    </option>
                                    <option value="travel_time_nearest_beach" {{ 'selected' if current_filters.sort_by == 'travel_time_nearest_beach' }}>
                                        {{ t('beach_distance') }}
                                    </option>
                                    <option value="created_at" {{ 'selected' if current_filters.sort_by == 'created_at' }}>
                                        {{ t('date_added') }}
                                    </option>
                                </select>
                                <select class="md-select body-large" name="order" style="width: 70px;">
                                    <option value="desc" {{ 'selected' if current_filters.order == 'desc' }}>‚Üì</option>
                                    <option value="asc" {{ 'selected' if current_filters.order == 'asc' }}>‚Üë</option>
                                </select>
                            </div>
                        </div>
                        
                    </div>
                    
                    <!-- Action Buttons and View Toggle -->
                    <div style="display: flex; align-items: center; justify-content: space-between; gap: var(--md-sys-spacing-4); padding-top: var(--md-sys-spacing-6); border-top: 1px solid var(--md-sys-color-outline-variant);">
                        <div style="display: flex; gap: var(--md-sys-spacing-3);">
                            <button type="submit" class="btn-filled">
                                <i class="fas fa-search" style="margin-right: var(--md-sys-spacing-2);"></i>{{ t('apply') }}
                            </button>
                            <a href="{{ url_for('main.lands') }}" class="btn-outlined">
                                <i class="fas fa-times" style="margin-right: var(--md-sys-spacing-2);"></i>{{ t('clear') }}
                            </a>
                        </div>
                        
                        <!-- View Toggle -->
                        <div style="display: flex; border: 1px solid var(--md-sys-color-outline); border-radius: var(--md-sys-shape-corner-large); overflow: hidden;" role="group" aria-label="View type">
                            <button type="button" 
                                    class="btn-icon {{ 'btn-filled' if current_filters.view_type == 'list' else 'btn-text' }}" 
                                    id="view-list-btn" 
                                    onclick="switchView('list')" 
                                    title="Table view - Compact data in rows"
                                    style="border-radius: 0; border: none; width: 48px; height: 48px;">
                                <i class="fas fa-list"></i>
                            </button>
                            
                            <button type="button" 
                                    class="btn-icon {{ 'btn-filled' if current_filters.view_type == 'cards' or not current_filters.view_type else 'btn-text' }}" 
                                    id="view-cards-btn" 
                                    onclick="switchView('cards')" 
                                    title="Card view - Visual property cards"
                                    style="border-radius: 0; border: none; border-left: 1px solid var(--md-sys-color-outline-variant); width: 48px; height: 48px;">
                                <i class="fas fa-th-large"></i>
                            </button>
                        </div>
                </form>
            </div>
        </div>

        <!-- Properties Display -->
        {% if lands %}
            <div class="mb-3 d-flex justify-content-between align-items-center">
                <div>
                    <strong>{{ pagination.total }} {{ t('properties_found') }}</strong>
                    {% if filters_applied %}
                        <span class="text-muted">(filtered)</span>
                    {% endif %}
                </div>
                <div class="d-flex align-items-center gap-3">
                    <!-- Compact Mode Toggle Buttons -->
                    <div class="btn-group btn-group-sm" role="group" aria-label="Analysis mode">
                        <button type="button" 
                                class="btn {{ 'btn-secondary' if current_filters.active_mode == 'combined' else 'btn-outline-secondary' }}"
                                onclick="switchMode('combined')" 
                                id="mode-combined-btn"
                                title="Combined Analysis - Shows overall property rating">
                            <i class="fas fa-balance-scale"></i>
                        </button>
                        <button type="button" 
                                class="btn {{ 'btn-success' if current_filters.active_mode == 'investment' else 'btn-outline-secondary' }}"
                                onclick="switchMode('investment')" 
                                id="mode-investment-btn"
                                title="Investment Analysis - Focus on rental yield and ROI">
                            <i class="fas fa-chart-line"></i>
                        </button>
                        <button type="button" 
                                class="btn {{ 'btn-warning' if current_filters.active_mode == 'lifestyle' else 'btn-outline-secondary' }}"
                                onclick="switchMode('lifestyle')" 
                                id="mode-lifestyle-btn"
                                title="Lifestyle Analysis - Focus on quality of life factors">
                            <i class="fas fa-home"></i>
                        </button>
                    </div>
                    <a href="{{ url_for('main.export_csv', mode=current_filters.mode, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '') }}" class="btn btn-success btn-sm" title="Download filtered data as CSV file">
                        <i class="fas fa-download me-1"></i>Export CSV
                    </a>
                </div>
            </div>
            
            <!-- List View (Table) -->
            <div id="list-view" class="view-container" style="{{ 'display: block;' if current_filters.view_type == 'list' else 'display: none;' }}">
                <div class="card">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="data-table">
                                <thead>
                                    <tr>
                                        <!-- Combined Mode: Show total score -->
                                        {% if current_filters.mode == 'combined' or not current_filters.mode %}
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'score_total' and current_filters.order == 'desc' else '' }}">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='score_total', order='desc' if current_filters.sort_by == 'score_total' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('score') }}
                                            </a>
                                        </th>
                                        {% elif current_filters.mode == 'investment' %}
                                        <!-- Investment Mode: Show only investment column -->
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'score_investment' and current_filters.order == 'desc' else '' }}" style="white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='score_investment', order='desc' if current_filters.sort_by == 'score_investment' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('investment') }}
                                            </a>
                                        </th>
                                        {% elif current_filters.mode == 'lifestyle' %}
                                        <!-- Lifestyle Mode: Show only lifestyle column -->
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'score_lifestyle' and current_filters.order == 'desc' else '' }}" style="white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='score_lifestyle', order='desc' if current_filters.sort_by == 'score_lifestyle' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('lifestyle') }}
                                            </a>
                                        </th>
                                        {% endif %}
                                        <th>{{ t('title') }}</th>
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'price' and current_filters.order == 'desc' else '' }}" style="min-width: 120px; white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='price', order='desc' if current_filters.sort_by == 'price' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('price') }}
                                            </a>
                                        </th>
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'area' and current_filters.order == 'desc' else '' }}" style="min-width: 100px; white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='area', order='desc' if current_filters.sort_by == 'area' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('area') }}
                                            </a>
                                        </th>
                                        <th style="white-space: nowrap;">{{ t('coords') }}</th>
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'travel_time_nearest_beach' and current_filters.order == 'desc' else '' }}" style="min-width: 110px; white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='travel_time_nearest_beach', order='asc' if current_filters.sort_by == 'travel_time_nearest_beach' and current_filters.order == 'desc' else 'desc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('beach') }}
                                            </a>
                                        </th>
                                        <th style="white-space: nowrap;">{{ t('travel') }}</th>
                                        <th>{{ t('type') }}</th>
                                        <th class="sortable {{ 'desc' if current_filters.sort_by == 'created_at' and current_filters.order == 'desc' else '' }}" style="min-width: 120px; white-space: nowrap;">
                                            <a href="{{ url_for('main.lands', mode=current_filters.mode, sort='created_at', order='desc' if current_filters.sort_by == 'created_at' and current_filters.order == 'asc' else 'asc', land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}" 
                                               class="text-decoration-none">
                                                {{ t('added') }}
                                            </a>
                                        </th>
                                        <th style="white-space: nowrap;">{{ t('actions') }}</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for land in lands %}
                                        <tr class="land-row" data-land-id="{{ land.id }}">
                                            <!-- Combined Mode: Show total score -->
                                            {% if current_filters.mode == 'combined' or not current_filters.mode %}
                                            <td data-label="{{ t('score') }}">
                                                {% if land.score_total is not none %}
                                                    <span class="score-badge {{ 'score-badge-high' if land.score_total >= 70 else 'score-badge-medium' if land.score_total >= 50 else 'score-badge-low' }}">
                                                        {{ "%.1f"|format(land.score_total) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            {% elif current_filters.mode == 'investment' %}
                                            <!-- Investment Mode: Show only investment score -->
                                            <td data-label="{{ t('investment') }}" style="background-color: rgba(25, 135, 84, 0.2);">
                                                {% if land.score_investment is not none %}
                                                    <span class="score-badge {{ 'score-badge-high' if land.score_investment >= 70 else 'score-badge-medium' if land.score_investment >= 50 else 'score-badge-low' }}">
                                                        {{ "%.1f"|format(land.score_investment) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            {% elif current_filters.mode == 'lifestyle' %}
                                            <!-- Lifestyle Mode: Show only lifestyle score -->
                                            <td data-label="{{ t('lifestyle') }}" style="background-color: rgba(255, 193, 7, 0.2);">
                                                {% if land.score_lifestyle is not none %}
                                                    <span class="score-badge {{ 'score-badge-high' if land.score_lifestyle >= 70 else 'score-badge-medium' if land.score_lifestyle >= 50 else 'score-badge-low' }}">
                                                        {{ "%.1f"|format(land.score_lifestyle) }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            {% endif %}
                                            <td data-label="{{ t('title') }}">
                                                <div class="fw-bold">
                                                    <a href="{{ url_for('main.land_detail', land_id=land.id) }}" 
                                                       class="text-decoration-none" 
                                                       title="{{ land.title }}">
                                                        {{ land.title }}
                                                    </a>
                                                </div>
                                            </td>
                                            <td data-label="{{ t('price') }}" style="min-width: 120px !important; white-space: nowrap !important;">
                                                {% if land.price %}
                                                    <div>
                                                        <strong>{{ "{:,.0f}".format(land.price) }}‚Ç¨</strong>
                                                        {% if land.previous_price and land.price_change_amount %}
                                                            {% if land.price_change_amount < 0 %}
                                                                <div class="price-change price-reduced">
                                                                    <i class="fas fa-arrow-down me-1"></i>
                                                                    <small class="text-success fw-bold">
                                                                        -{{ "{:,.0f}".format(-land.price_change_amount) }}‚Ç¨ 
                                                                        ({{ "%.1f"|format(-land.price_change_percentage) }}%)
                                                                    </small>
                                                                    <br><small class="text-muted">was {{ "{:,.0f}".format(land.previous_price) }}‚Ç¨</small>
                                                                </div>
                                                            {% elif land.price_change_amount > 0 %}
                                                                <div class="price-change price-increased">
                                                                    <i class="fas fa-arrow-up me-1"></i>
                                                                    <small class="text-danger fw-bold">
                                                                        +{{ "{:,.0f}".format(land.price_change_amount) }}‚Ç¨ 
                                                                        (+{{ "%.1f"|format(land.price_change_percentage) }}%)
                                                                    </small>
                                                                    <br><small class="text-muted">was {{ "{:,.0f}".format(land.previous_price) }}‚Ç¨</small>
                                                                </div>
                                                            {% endif %}
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('area') }}" style="min-width: 100px !important; white-space: nowrap !important;">
                                                {% if land.area %}
                                                    {{ "{:,.0f}".format(land.area) }} m¬≤
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('coords') }}">
                                                {% if land.location_lat and land.location_lon %}
                                                    <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}" 
                                                       target="_blank" class="text-decoration-none" 
                                                       title="{% if land.location_accuracy == 'precise' %}Precise location{% elif land.location_accuracy == 'approximate' %}Approximate location{% else %}Unknown accuracy{% endif %}">
                                                        {% if land.location_accuracy == 'precise' %}
                                                            <i class="fas fa-map-marker-alt me-1 text-success" title="Precise location"></i>
                                                        {% else %}
                                                            <i class="fas fa-map-marker-alt me-1 text-danger" title="Approximate location"></i>
                                                        {% endif %}
                                                        <small>{{ "%.4f"|format(land.location_lat) }}, {{ "%.4f"|format(land.location_lon) }}</small>
                                                    </a>
                                                {% else %}
                                                    <span class="text-muted" title="Coordinates unavailable">
                                                        <i class="fas fa-map-marker-slash me-1"></i>
                                                        {% if land.municipality %}
                                                            <small>{{ land.municipality }}</small>
                                                        {% else %}
                                                            -
                                                        {% endif %}
                                                    </span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('beach') }}" style="min-width: 110px !important; white-space: nowrap !important;">
                                                {% if land.travel_time_nearest_beach %}
                                                    <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/{{ land.nearest_beach_name if land.nearest_beach_name else 'Playa' }},+Asturias,+Spain" 
                                                       target="_blank" class="text-decoration-none text-info d-flex align-items-center" 
                                                       title="Drive to {{ land.nearest_beach_name if land.nearest_beach_name else 'nearest beach' }}">
                                                        <i class="fas fa-umbrella-beach me-1"></i>
                                                        <span class="fw-bold">{{ land.travel_time_nearest_beach }}min</span>
                                                    </a>
                                                    {% if land.nearest_beach_name %}
                                                        <small class="text-muted d-block compact-text" title="{{ land.nearest_beach_name }}">{{ land.nearest_beach_name }}</small>
                                                    {% endif %}
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('travel') }}" style="min-width: 140px !important; white-space: nowrap !important;">
                                                {% if land.travel_time_oviedo or land.travel_time_gijon %}
                                                    <div class="d-flex flex-wrap align-items-center gap-1 small">
                                                        {% if land.travel_time_oviedo %}
                                                            <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Oviedo,+Asturias,+Spain" 
                                                               target="_blank" class="text-decoration-none d-inline-flex align-items-center me-2" title="Drive to Oviedo">
                                                                <i class="fas fa-car me-1 text-primary"></i>
                                                                <span class="fw-bold">{{ land.travel_time_oviedo }}min</span>
                                                                <small class="text-muted ms-1">OV</small>
                                                            </a>
                                                        {% endif %}
                                                        {% if land.travel_time_gijon %}
                                                            <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Gij√≥n,+Asturias,+Spain" 
                                                               target="_blank" class="text-decoration-none d-inline-flex align-items-center" title="Drive to Gij√≥n">
                                                                <i class="fas fa-car me-1 text-primary"></i>
                                                                <span class="fw-bold">{{ land.travel_time_gijon }}min</span>
                                                                <small class="text-muted ms-1">GJ</small>
                                                            </a>
                                                        {% endif %}
                                                    </div>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('type') }}">
                                                {% if land.land_type %}
                                                    <span class="badge {{ 'bg-success' if land.land_type == 'developed' else 'bg-warning' }}">
                                                        {{ land.land_type.title() }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('added') }}" style="min-width: 120px !important; white-space: nowrap !important;">
                                                {% if land.created_at %}
                                                    <small style="white-space: nowrap !important; display: inline-block;">{{ land.created_at.strftime('%d %b %y') }}</small>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            </td>
                                            <td data-label="{{ t('actions') }}">
                                                <div class="d-flex gap-1">
                                                    {% if land.url %}
                                                        <a href="{{ land.url }}" target="_blank" 
                                                           class="btn btn-success btn-sm" title="View on Idealista">
                                                            <i class="fas fa-home"></i>
                                                        </a>
                                                    {% endif %}
                                                </div>
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Properties Grid (Cards View) -->
            <div id="cards-view" class="view-container" style="{{ 'display: block;' if current_filters.view_type == 'cards' or not current_filters.view_type else 'display: none;' }}">
                <div class="row" id="properties-grid">
                {% for land in lands %}
                    <div class="col-lg-6 col-xl-4 mb-4">
                        <div class="card h-100 property-card" data-land-id="{{ land.id }}" style="overflow: hidden;">
                            <!-- Card Header with Score and AI Indicator -->
                            <div class="card-header bg-dark text-white" style="padding: 0.5rem 1rem;">
                                <div class="d-flex justify-content-between align-items-center">
                                    <div class="d-flex align-items-center" style="min-width: 0; flex: 1;">
                                        <!-- Combined Mode: Show total score -->
                                        {% if current_filters.mode == 'combined' or not current_filters.mode %}
                                            {% if land.score_total is not none %}
                                                <span class="score-badge {{ 'score-badge-high' if land.score_total >= 70 else 'score-badge-medium' if land.score_total >= 50 else 'score-badge-low' }} me-2" style="flex-shrink: 0;">
                                                    {{ "%.1f"|format(land.score_total) }}
                                                </span>
                                            {% endif %}
                                        {% else %}
                                        <!-- Dual Score Mode: Show investment and lifestyle scores -->
                                            <div class="d-flex gap-1 me-2" style="flex-shrink: 0;">
                                                {% if land.score_investment is not none %}
                                                    <span class="badge {{ 'd-none d-md-inline' if current_filters.mode == 'lifestyle' else '' }}" 
                                                          style="background-color: {{ 'var(--bs-success)' if land.score_investment >= 70 else 'var(--bs-warning)' if land.score_investment >= 50 else 'var(--bs-danger)' }}; 
                                                                 {{ 'border: 2px solid #198754; font-weight: bold;' if current_filters.mode == 'investment' else 'opacity: 0.8;' }}">
                                                        {{ "%.1f"|format(land.score_investment) }}
                                                    </span>
                                                {% endif %}
                                                {% if land.score_lifestyle is not none %}
                                                    <span class="badge {{ 'd-none d-md-inline' if current_filters.mode == 'investment' else '' }}" 
                                                          style="background-color: {{ 'var(--bs-success)' if land.score_lifestyle >= 70 else 'var(--bs-warning)' if land.score_lifestyle >= 50 else 'var(--bs-danger)' }}; 
                                                                 {{ 'border: 2px solid #ffc107; font-weight: bold;' if current_filters.mode == 'lifestyle' else 'opacity: 0.8;' }}">
                                                        {{ "%.1f"|format(land.score_lifestyle) }}
                                                    </span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                        <span class="badge {{ 'bg-success' if land.land_type == 'developed' else 'bg-warning' }}" style="flex-shrink: 0;">
                                            {{ land.land_type.title() if land.land_type else 'Unknown' }}
                                        </span>
                                    </div>
                                    <div class="ms-2" style="flex-shrink: 0;">
                                        <small>{{ land.created_at.strftime('%d %b %y') if land.created_at else '-' }}</small>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Body -->
                            <div class="card-body">
                                <h6 class="card-title">
                                    <a href="{{ url_for('main.land_detail', land_id=land.id) }}" 
                                       class="text-decoration-none table-title" 
                                       title="{{ land.title }}" 
                                       style="max-width: 300px;">
                                        {{ land.title }}
                                    </a>
                                </h6>
                                
                                <!-- Price and Area -->
                                <div class="row mb-3">
                                    <div class="col-6">
                                        {% if land.price %}
                                            <div>
                                                <strong class="text-success">‚Ç¨{{ "{:,.0f}".format(land.price) }}</strong>
                                                {% if land.previous_price and land.price_change_amount %}
                                                    {% if land.price_change_amount < 0 %}
                                                        <div class="price-change-card mt-1">
                                                            <small class="text-success d-flex align-items-center">
                                                                <i class="fas fa-arrow-down me-1"></i>
                                                                <span class="fw-bold">-{{ "{:,.0f}".format(-land.price_change_amount) }}‚Ç¨</span>
                                                            </small>
                                                            <small class="text-muted">was ‚Ç¨{{ "{:,.0f}".format(land.previous_price) }}</small>
                                                        </div>
                                                    {% elif land.price_change_amount > 0 %}
                                                        <div class="price-change-card mt-1">
                                                            <small class="text-danger d-flex align-items-center">
                                                                <i class="fas fa-arrow-up me-1"></i>
                                                                <span class="fw-bold">+{{ "{:,.0f}".format(land.price_change_amount) }}‚Ç¨</span>
                                                            </small>
                                                            <small class="text-muted">was ‚Ç¨{{ "{:,.0f}".format(land.previous_price) }}</small>
                                                        </div>
                                                    {% endif %}
                                                {% endif %}
                                            </div>
                                        {% else %}
                                            <span class="text-muted">Price N/A</span>
                                        {% endif %}
                                    </div>
                                    <div class="col-6">
                                        <span class="text-muted">
                                            {% if land.area %}
                                                {{ "{:,.0f}".format(land.area) }} m¬≤
                                            {% else %}
                                                Area N/A
                                            {% endif %}
                                        </span>
                                    </div>
                                </div>
                                
                                <!-- Location -->
                                <div class="mb-3">
                                    {% if land.location_lat and land.location_lon %}
                                        <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}" 
                                           target="_blank" class="text-decoration-none d-flex align-items-center">
                                            {% if land.location_accuracy == 'precise' %}
                                                <i class="fas fa-map-marker-alt me-2 text-success"></i>
                                            {% else %}
                                                <i class="fas fa-map-marker-alt me-2 text-warning"></i>
                                            {% endif %}
                                            <small>{{ land.municipality or 'Unknown location' }}</small>
                                        </a>
                                    {% else %}
                                        <div class="text-muted">
                                            <i class="fas fa-map-marker-slash me-2"></i>
                                            <small>{{ land.municipality or 'Location unknown' }}</small>
                                        </div>
                                    {% endif %}
                                </div>
                                
                                <!-- Travel Times -->
                                <div class="row mb-3">
                                    {% if land.travel_time_nearest_beach %}
                                        <div class="col-12 mb-2">
                                            <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/{{ land.nearest_beach_name if land.nearest_beach_name else 'Playa' }},+Asturias,+Spain" 
                                               target="_blank" class="text-decoration-none d-flex align-items-center">
                                                <i class="fas fa-umbrella-beach me-2 text-info"></i>
                                                <span class="fw-bold">{{ land.travel_time_nearest_beach }}min</span>
                                                <small class="text-muted ms-2">to beach</small>
                                            </a>
                                        </div>
                                    {% endif %}
                                    
                                    <div class="col-12">
                                        <div class="d-flex flex-wrap gap-3">
                                            {% if land.travel_time_oviedo %}
                                                <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Oviedo,+Asturias,+Spain" 
                                                   target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-car me-1 text-primary"></i>
                                                    <span class="fw-bold">{{ land.travel_time_oviedo }}min</span>
                                                    <small class="text-muted">OV</small>
                                                </a>
                                            {% endif %}
                                            {% if land.travel_time_gijon %}
                                                <a href="https://www.google.com/maps/dir/{{ land.location_lat }},{{ land.location_lon }}/Gij√≥n,+Asturias,+Spain" 
                                                   target="_blank" class="text-decoration-none">
                                                    <i class="fas fa-car me-1 text-primary"></i>
                                                    <span class="fw-bold">{{ land.travel_time_gijon }}min</span>
                                                    <small class="text-muted">GJ</small>
                                                </a>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Card Footer with Actions -->
                            <div class="card-footer d-flex justify-content-between align-items-center">
                                <div>
                                    {% if land.url %}
                                        <a href="{{ land.url }}" target="_blank" 
                                           class="btn btn-success btn-sm" title="View on Idealista">
                                            <i class="fas fa-home me-1"></i>
                                            Idealista
                                        </a>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                {% endfor %}
                </div>
            </div>
                
                <!-- Pagination -->
                {% if pagination and pagination.total > 0 %}
                <div class="card-footer">
                    <div class="row align-items-center">
                        <div class="col-md-4">
                            <span class="text-muted">
                                Showing {{ ((pagination.page - 1) * pagination.per_page) + 1 }} - 
                                {{ (pagination.page * pagination.per_page) if (pagination.page * pagination.per_page) < pagination.total else pagination.total }} 
                                of {{ pagination.total }} results
                            </span>
                        </div>
                        <div class="col-md-4 text-center">
                            <div class="d-inline-flex align-items-center">
                                <span class="text-muted me-2 small">Show:</span>
                                <select class="form-select form-select-sm" style="width: auto;" 
                                        onchange="window.location.href=updateUrlParameter(window.location.href, 'per_page', this.value)">
                                    <option value="10" {{ 'selected' if current_filters.per_page == 10 }}>10</option>
                                    <option value="25" {{ 'selected' if current_filters.per_page == 25 }}>25</option>
                                    <option value="50" {{ 'selected' if current_filters.per_page == 50 }}>50</option>
                                    <option value="100" {{ 'selected' if current_filters.per_page == 100 }}>100</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            {% if pagination.pages > 1 %}
                            <nav aria-label="Page navigation">
                                <ul class="pagination pagination-sm mb-0 justify-content-end">
                                    <!-- Previous page -->
                                    {% if pagination.has_prev %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main.lands', mode=current_filters.mode, page=pagination.prev_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}">
                                                <i class="fas fa-chevron-left"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                    
                                    <!-- Page numbers -->
                                    {% for page_num in pagination.iter_pages(left_edge=1, right_edge=1, left_current=1, right_current=2) %}
                                        {% if page_num %}
                                            {% if page_num != pagination.page %}
                                                <li class="page-item">
                                                    <a class="page-link" href="{{ url_for('main.lands', mode=current_filters.mode, page=page_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}">
                                                        {{ page_num }}
                                                    </a>
                                                </li>
                                            {% else %}
                                                <li class="page-item active">
                                                    <span class="page-link">{{ page_num }}</span>
                                                </li>
                                            {% endif %}
                                        {% else %}
                                            <li class="page-item disabled">
                                                <span class="page-link">‚Ä¶</span>
                                            </li>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Next page -->
                                    {% if pagination.has_next %}
                                        <li class="page-item">
                                            <a class="page-link" href="{{ url_for('main.lands', mode=current_filters.mode, page=pagination.next_num, per_page=current_filters.per_page, sort=current_filters.sort_by, order=current_filters.order, land_type=current_filters.land_type, municipality=current_filters.municipality, search=current_filters.search, sea_view='on' if current_filters.sea_view else '', view_type=current_filters.view_type) }}">
                                                <i class="fas fa-chevron-right"></i>
                                            </a>
                                        </li>
                                    {% endif %}
                                </ul>
                            </nav>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>
        {% else %}
            <div class="text-center py-5">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h4>No properties found</h4>
                <p class="text-muted">Try adjusting your filters or run a manual sync to fetch new data.</p>
                <button class="btn-filled" 
                        hx-post="{{ url_for('api.manual_ingestion') }}"
                        hx-trigger="click"
                        hx-indicator="#ingestion-spinner">
                    <i class="fas fa-sync-alt me-1"></i>
                    Run Manual Sync
                </button>
            </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Auto-submit form on filter changes (debounced)
let filterTimeout;
document.addEventListener('DOMContentLoaded', function() {
    const form = document.getElementById('filter-form');
    const inputs = form.querySelectorAll('input, select');
    
    inputs.forEach(input => {
        input.addEventListener('change', function() {
            clearTimeout(filterTimeout);
            filterTimeout = setTimeout(() => {
                if (input.name !== 'search') {
                    form.submit();
                }
            }, 300);
        });
        
        if (input.name === 'search') {
            input.addEventListener('input', function() {
                clearTimeout(filterTimeout);
                filterTimeout = setTimeout(() => {
                    form.submit();
                }, 1000);
            });
        }
    });
});

// HTMX event listeners
document.addEventListener('htmx:responseError', function(evt) {
    alert('Error: ' + evt.detail.xhr.responseText);
});

document.addEventListener('htmx:afterRequest', function(evt) {
    if (evt.detail.successful) {
        // Reload page after successful ingestion
        if (evt.detail.xhr.response) {
            const response = JSON.parse(evt.detail.xhr.response);
            if (response.success) {
                setTimeout(() => {
                    window.location.reload();
                }, 2000);
            }
        }
    }
});

// AI Analysis Management
// Legacy function - no longer used in new UI 
// Cards view now uses generateAIAnalysisOnly() and viewAIAnalysis() like table view
async function toggleAIAnalysis(landId) {
    // For backwards compatibility only - redirect to detail page
    window.location.href = `/lands/${landId}`;
}



function renderListItems(items, label, colorClass) {
    if (!items || !Array.isArray(items) || items.length === 0) return '';
    
    const listItems = items.map(item => 
        `<li><i class="fas fa-dot-circle text-${colorClass} me-1"></i>${item}</li>`
    ).join('');
    
    return `<div class="mb-2"><strong>${label}</strong><ul class="list-unstyled mb-1">${listItems}</ul></div>`;
}

function renderSimilarProperties(similarProperties) {
    if (!similarProperties || !Array.isArray(similarProperties) || similarProperties.length === 0) {
        return '<p class="text-muted">No similar properties found</p>';
    }
    
    const propertyCards = similarProperties.map(prop => {
        const priceText = prop.price ? `‚Ç¨${prop.price.toLocaleString()}` : 'Price N/A';
        const areaText = prop.area ? `${prop.area.toLocaleString()}m¬≤` : 'Area N/A';
        const scoreText = prop.score_total ? `${prop.score_total.toFixed(1)}/100` : 'Not scored';
        const scoreClass = prop.score_total ? (prop.score_total >= 70 ? 'text-success' : prop.score_total >= 50 ? 'text-warning' : 'text-danger') : 'text-muted';
        
        const landTypeClass = prop.land_type === 'developed' ? 'bg-success' : 'bg-warning';
        
        return `
            <div class="similar-property-card border rounded p-3 mb-2" style="background-color: rgba(255,255,255,0.05);">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <div class="flex-grow-1">
                        <h6 class="mb-1">
                            <a href="/lands/${prop.id}" class="text-decoration-none text-white">
                                ${prop.title ? prop.title.substring(0, 50) + (prop.title.length > 50 ? '...' : '') : 'Property #' + prop.id}
                            </a>
                        </h6>
                        <div class="d-flex flex-wrap gap-3 small text-muted">
                            <span><i class="fas fa-euro-sign"></i> ${priceText}</span>
                            <span><i class="fas fa-ruler-combined"></i> ${areaText}</span>
                            <span><i class="fas fa-map-marker-alt"></i> ${prop.municipality || 'Location N/A'}</span>
                        </div>
                    </div>
                    <div class="text-end">
                        <span class="badge ${landTypeClass} small">${prop.land_type || 'Unknown'}</span>
                        <div class="small ${scoreClass} mt-1">
                            <i class="fas fa-star"></i> ${scoreText}
                        </div>
                        <div class="mt-2">
                            <a href="/lands/${prop.id}" class="btn btn-sm btn-outline-light">
                                <i class="fas fa-eye"></i> View Details
                            </a>
                            <a href="${prop.url || '#'}" class="btn btn-sm btn-outline-primary ms-1" target="_blank">
                                <i class="fas fa-external-link-alt"></i> Idealista
                            </a>
                        </div>
                        <div class="small text-muted mt-1">Similar property</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    return `
        <div class="similar-properties-list">
            ${propertyCards}
        </div>
    `;
}

function getPriceVerdictClass(verdict) {
    switch(verdict) {
        case 'Fair Price': return 'bg-success';
        case 'Underpriced': return 'bg-primary';
        case 'Overpriced': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function getInvestmentRatingClass(rating) {
    switch(rating) {
        case 'HIGH': return 'bg-success';
        case 'MEDIUM': return 'bg-warning';
        case 'LOW': return 'bg-danger';
        default: return 'bg-secondary';
    }
}

function formatUIText(value) {
    if (!value) return 'Unknown';
    // Convert values for better UI display
    const formatMap = {
        'HIGH': 'High',
        'MEDIUM': 'Medium', 
        'LOW': 'Low',
        'RISING': 'Rising',
        'STABLE': 'Stable',
        'DECLINING': 'Declining',
        'EXCELLENT': 'Excellent',
        'GOOD': 'Good',
        'MODERATE': 'Moderate',
        'BELOW AVERAGE': 'Below Average'
    };
    return formatMap[value] || value;
}


// Generate AI Analysis and redirect to details page
async function generateAIAnalysisAndRedirect(landId) {
    try {
        // Find the specific clicked icon using a more targeted approach
        const clickedIcon = event.target;
        
        // Show loading state for the clicked icon
        const originalClass = clickedIcon.className;
        clickedIcon.className = 'fas fa-spinner fa-spin me-1';
        clickedIcon.style.pointerEvents = 'none';

        // Generate AI analysis
        const response = await fetch(`/api/analyze/property/${landId}/structured`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (response.ok) {
            // Redirect to property details page
            window.location.href = `/lands/${landId}`;
        } else {
            // Restore icon on error
            clickedIcon.className = originalClass;
            clickedIcon.style.pointerEvents = 'auto';
            alert('Failed to generate AI analysis. Please try again.');
        }
    } catch (error) {
        console.error('Error generating AI analysis:', error);
        // Restore icon on error
        const clickedIcon = event.target;
        clickedIcon.className = 'fas fa-brain text-muted me-1';
        clickedIcon.style.pointerEvents = 'auto';
        alert('Failed to generate AI analysis. Please try again.');
    }
}

// Generate AI Analysis only (no display in list)
async function generateAIAnalysisOnly(landId) {
    // Find button more reliably - check both AI Analysis buttons in cards and table
    const button = document.querySelector(`button[data-land-id="${landId}"][onclick*="generateAIAnalysisOnly"]`) || 
                   document.querySelector(`[data-land-id="${landId}"].ai-analyze-btn`);
    
    if (!button) {
        console.error('AI Analysis button not found for land:', landId);
        return;
    }
    
    // Store original button content to preserve exact layout
    const originalInnerHTML = button.innerHTML;
    const originalTitle = button.title;
    const originalOnclick = button.onclick;
    
    // Find the icon inside the button (don't change button text/size)
    const icon = button.querySelector('i.fas.fa-brain');
    if (!icon) {
        console.error('Brain icon not found in button');
        return;
    }
    
    // ONLY change the icon color with gradient - NO text changes
    icon.style.background = 'linear-gradient(45deg, #007bff, #0056b3, #007bff)';
    icon.style.backgroundSize = '200% 200%';
    icon.style.animation = 'gradientShift 1.5s ease-in-out infinite';
    icon.style.webkitBackgroundClip = 'text';
    icon.style.webkitTextFillColor = 'transparent';
    icon.style.backgroundClip = 'text';
    
    button.disabled = true;
    button.title = 'Generating AI Analysis...';
    
    try {
        const response = await fetch(`/api/analyze/property/${landId}/structured`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            }
        });

        if (!response.ok) {
            let errorMsg = 'Analysis service unavailable';
            if (response.status === 529) {
                errorMsg = 'Claude AI service is temporarily overloaded. Please try again in a few minutes.';
            } else if (response.status === 401) {
                errorMsg = 'API authentication failed. Please check your API key configuration.';
            } else if (response.status === 429) {
                errorMsg = 'Too many requests. Please wait a moment before trying again.';
            }
            throw new Error(errorMsg);
        }

        const data = await response.json();
        if (data.success) {
            // Reset icon styles and change to success state - NO REDIRECT
            icon.style.background = '';
            icon.style.animation = '';
            icon.style.webkitBackgroundClip = '';
            icon.style.webkitTextFillColor = '';
            icon.style.backgroundClip = '';
            
            // Change icon to success color to show analysis is complete
            icon.style.color = '#28a745'; // Green color to show success
            button.disabled = false;
            button.title = 'AI Analysis Complete - Click property to view details';
        } else {
            throw new Error(data.error || 'Analysis failed');
        }
    } catch (error) {
        console.error('AI Analysis Error:', error);
        
        // Reset icon styles to original state
        icon.style.background = '';
        icon.style.animation = '';
        icon.style.webkitBackgroundClip = '';
        icon.style.webkitTextFillColor = '';
        icon.style.backgroundClip = '';
        
        // Restore original button state completely
        button.innerHTML = originalInnerHTML;
        button.title = originalTitle;
        button.onclick = originalOnclick;
        button.disabled = false;
        
        // Show user-friendly error message (console only for card view)
        console.warn('AI Analysis failed:', error.message);
    }
}

// View AI Analysis - redirect to details page
function viewAIAnalysis(landId) {
    window.location.href = `/lands/${landId}`;
}



// View Switching without page reload
function switchView(viewType) {
    const listView = document.getElementById('list-view');
    const cardsView = document.getElementById('cards-view');
    const listBtn = document.getElementById('view-list-btn');
    const cardsBtn = document.getElementById('view-cards-btn');
    
    // Save user preference to localStorage
    localStorage.setItem('preferredViewType', viewType);
    
    // Add transition classes
    listView.style.transition = 'opacity 0.3s ease-in-out';
    cardsView.style.transition = 'opacity 0.3s ease-in-out';
    
    if (viewType === 'list') {
        // Fade out current view
        cardsView.style.opacity = '0';
        setTimeout(() => {
            cardsView.style.display = 'none';
            listView.style.display = 'block';
            listView.style.opacity = '0';
            // Fade in new view
            setTimeout(() => {
                listView.style.opacity = '1';
            }, 10);
        }, 300);
        
        // Update button states
        listBtn.classList.add('active');
        cardsBtn.classList.remove('active');
    } else {
        // Fade out current view
        listView.style.opacity = '0';
        setTimeout(() => {
            listView.style.display = 'none';
            cardsView.style.display = 'block';
            cardsView.style.opacity = '0';
            // Fade in new view
            setTimeout(() => {
                cardsView.style.opacity = '1';
            }, 10);
        }, 300);
        
        // Update button states
        cardsBtn.classList.add('active');
        listBtn.classList.remove('active');
    }
    
    // Update URL without page reload
    updateViewTypeInUrl(viewType);
}

function updateViewTypeInUrl(viewType) {
    const url = new URL(window.location);
    url.searchParams.set('view_type', viewType);
    
    // Update URL without reload
    window.history.pushState({ viewType: viewType }, '', url.toString());
}

// Handle browser back/forward buttons
window.addEventListener('popstate', function(event) {
    if (event.state && event.state.viewType) {
        const viewType = event.state.viewType;
        switchView(viewType);
    }
});

// Initialize view on page load
document.addEventListener('DOMContentLoaded', function() {
    const listView = document.getElementById('list-view');
    const cardsView = document.getElementById('cards-view');
    const listBtn = document.getElementById('view-list-btn');
    const cardsBtn = document.getElementById('view-cards-btn');
    
    // Load user preference from localStorage
    const savedViewType = localStorage.getItem('preferredViewType');
    const currentServerView = '{{ current_filters.view_type or "cards" }}';
    
    if (savedViewType && (savedViewType === 'list' || savedViewType === 'cards')) {
        // Apply saved preference if different from server-side default
        if (savedViewType !== currentServerView) {
            // Switch instantly without animation on page load
            if (savedViewType === 'list') {
                cardsView.style.display = 'none';
                listView.style.display = 'block';
                listView.style.opacity = '1';
                listBtn.classList.add('active');
                cardsBtn.classList.remove('active');
                
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('view_type', 'list');
                window.history.replaceState({ viewType: 'list' }, '', url.toString());
            } else {
                listView.style.display = 'none';
                cardsView.style.display = 'block';
                cardsView.style.opacity = '1';
                cardsBtn.classList.add('active');
                listBtn.classList.remove('active');
                
                // Update URL without reload
                const url = new URL(window.location);
                url.searchParams.set('view_type', 'cards');
                window.history.replaceState({ viewType: 'cards' }, '', url.toString());
            }
        } else {
            // Set opacity for the current view
            if (listView.style.display !== 'none') {
                listView.style.opacity = '1';
            }
            if (cardsView.style.display !== 'none') {
                cardsView.style.opacity = '1';
            }
        }
    } else {
        // Set opacity for the current view (no saved preference)
        if (listView.style.display !== 'none') {
            listView.style.opacity = '1';
        }
        if (cardsView.style.display !== 'none') {
            cardsView.style.opacity = '1';
        }
    }
});

// Mode switching functionality
function switchMode(mode) {
    const url = new URL(window.location);
    url.searchParams.set('mode', mode);
    
    // Auto-sync sort with mode selection for better UX
    const currentSort = url.searchParams.get('sort');
    if (mode === 'investment' && currentSort !== 'score_investment') {
        url.searchParams.set('sort', 'score_investment');
    } else if (mode === 'lifestyle' && currentSort !== 'score_lifestyle') {
        url.searchParams.set('sort', 'score_lifestyle');
    } else if (mode === 'combined' && currentSort !== 'score_total') {
        url.searchParams.set('sort', 'score_total');
    }
    
    // Reset to first page when changing mode
    url.searchParams.delete('page');
    
    // Update the URL and reload to apply mode change
    window.location.href = url.toString();
}
</script>

<style>
@keyframes gradientShift {
    0% {
        background-position: 0% 50%;
    }
    50% {
        background-position: 100% 50%;
    }
    100% {
        background-position: 0% 50%;
    }
}

.ai-analyze-btn {
    transition: all 0.3s ease-in-out;
}
</style>
{% endblock %}
