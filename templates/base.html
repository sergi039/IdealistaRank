<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}Idealista Land Watch & Rank{% endblock %}</title>
    
    <!-- Material Design 3 CSS Framework -->
    <link href="https://unpkg.com/@material/web@1.0.1/all.css" rel="stylesheet">
    
    <!-- Google Fonts - Roboto (MD3 Standard) -->
    <link href="https://fonts.googleapis.com/css2?family=Roboto:ital,wght@0,100;0,300;0,400;0,500;0,700;0,900;1,100;1,300;1,400;1,500;1,700;1,900&display=swap" rel="stylesheet">
    
    <!-- Material Symbols (Latest Icon Set) -->
    <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" rel="stylesheet">
    
    <!-- Material Design 3 Dynamic Colors -->
    <link href="https://unpkg.com/@material/material-color-utilities@0.2.7/dist/css/material-dynamic-colors.css" rel="stylesheet">
    
    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    
    <!-- Custom MD3 Theme CSS -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3-theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/md3-components.css') }}">
    
    <script>
        function setLanguage(langCode) {
            fetch('/api/set-language', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ language: langCode })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) location.reload();
            })
            .catch(error => console.error('Error setting language:', error));
        }
    </script>
</head>
<body>
    <!-- MD3 Navigation -->
    <header class="md3-top-app-bar">
        <div class="md3-top-app-bar__title">
            <a href="{{ url_for('main.index') }}" style="text-decoration: none; color: inherit; display: flex; align-items: center; gap: var(--md-sys-spacing-3);">
                <span class="material-symbols-outlined">map</span>
                {{ t('app_title') }}
            </a>
        </div>
        
        <nav class="md3-top-app-bar__actions">
            <a href="{{ url_for('main.lands') }}" class="md3-button md3-button--text">
                <span class="material-symbols-outlined">list</span>
                {{ t('properties') }}
            </a>
            
            <a href="{{ url_for('main.criteria') }}" class="md3-button md3-button--text">
                <span class="material-symbols-outlined">tune</span>
                {{ t('scoring_criteria') }}
            </a>
            
            <button class="md3-button md3-button--outlined" 
                    hx-post="{{ url_for('api.manual_ingestion') }}"
                    hx-trigger="click"
                    hx-indicator="#ingestion-spinner">
                <span class="material-symbols-outlined">sync</span>
                {{ t('manual_sync') }}
            </button>
            
            <div class="md3-dropdown">
                <button class="md3-button md3-button--outlined" 
                        type="button" 
                        onclick="toggleDropdown('languageDropdown')">
                    <span class="material-symbols-outlined">language</span>
                    <span>{{ 'EN' if get_current_language() == 'en' else 'ES' }}</span>
                </button>
                <div id="languageDropdown" class="md3-dropdown-menu">
                    <a href="#" onclick="setLanguage('en')" class="md3-dropdown-item">
                        ðŸ‡¬ðŸ‡§ English
                    </a>
                    <a href="#" onclick="setLanguage('es')" class="md3-dropdown-item">
                        ðŸ‡ªðŸ‡¸ EspaÃ±ol
                    </a>
                </div>
            </div>
        </nav>
    </header>

    <!-- Loading indicators -->
    <div id="ingestion-spinner" class="htmx-indicator">
        <div class="container mt-3">
            <div class="alert alert-info">
                <span class="material-symbols-outlined md3-spinner">progress_activity</span>
                {{ t('running_gmail_ingestion') }}
            </div>
        </div>
    </div>
    

    <!-- Flash messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            <div class="container mt-3">
                {% for category, message in messages %}
                    <div class="alert alert-{{ 'danger' if category == 'error' else 'success' }} alert-dismissible fade show">
                        {{ message }}
                        <button type="button" class="md3-button md3-button--icon" onclick="this.parentElement.remove()">
                            <span class="material-symbols-outlined">close</span>
                        </button>
                    </div>
                {% endfor %}
            </div>
        {% endif %}
    {% endwith %}

    <!-- Main content -->
    <main class="container my-4">
        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-dark text-light py-4 mt-5">
        <div class="container">
            <div class="row">
                <div class="col-md-6">
                    <h6>Idealista Land Watch & Rank</h6>
                    <p class="small text-muted">
                        Automated Spanish real estate analysis with multi-criteria scoring
                    </p>
                </div>
                <div class="col-md-6 text-md-end">
                    <small class="text-muted">
                        Automated real estate analysis platform
                    </small>
                </div>
            </div>
        </div>
    </footer>

    <!-- MD3 Navigation Scripts -->
    <script>
        // Simple dropdown toggle
        function toggleDropdown(id) {
            const dropdown = document.getElementById(id);
            dropdown.classList.toggle('show');
        }
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function(event) {
            const dropdowns = document.querySelectorAll('.md3-dropdown-menu');
            dropdowns.forEach(dropdown => {
                if (!dropdown.closest('.md3-dropdown').contains(event.target)) {
                    dropdown.classList.remove('show');
                }
            });
        });
    </script>
    
    <!-- Custom JS -->
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
    
    {% block scripts %}{% endblock %}
</body>
</html>
