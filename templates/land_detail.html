{% extends "base.html" %}

{% block title %}{{ land.title }} - Idealista Land Watch{% endblock %}

{% block content %}
<!-- MD3 Page Container -->
<div class="md3-container">
    <!-- MD3 Page Header -->
    <div class="md3-page-header">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; gap: var(--md-sys-spacing-4);">
            <div class="flex-grow-1">
                <h1 class="md3-page-title">
                    <span class="material-symbols-outlined">location_on</span>
                    {{ land.title[:60] }}{% if land.title|length > 60 %}...{% endif %}
                </h1>
            </div>
            <a href="{{ url_for('main.lands', sort=request.args.get('sort'), order=request.args.get('order'), land_type=request.args.get('land_type'), municipality=request.args.get('municipality'), search=request.args.get('search'), per_page=request.args.get('per_page')) }}" class="md3-button md3-button--outlined">
                <span class="material-symbols-outlined">arrow_back</span>
                {{ t('back') }}
            </a>
        </div>
    </div>

    <!-- MD3 Main Content Grid -->
    <div class="md3-grid" style="grid-template-columns: 2fr 1fr; gap: var(--md-sys-spacing-6);" data-land-id="{{ land.id }}">
        
        <!-- Main Property Information Column -->
        <div class="md3-main-column">
            <!-- Main Property Card -->
            <div class="md3-card md3-card--elevated md3-mb-6">
                <div class="md3-card__header">
                    <div style="flex: 1;">
                        <h2 class="title-large" style="margin: 0;">{{ land.title }}</h2>
                    </div>
                    <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                        {% if land.score_total %}
                            <span class="md3-chip md3-chip--{{ 'success' if land.score_total >= 70 else 'warning' if land.score_total >= 50 else 'error' }}">
                                {{ t('score') }}: {{ "%.1f"|format(land.score_total) }}
                            </span>
                        {% endif %}
                        <button type="button" class="md3-button md3-button--icon" onclick="openScoreModal()">
                            <span class="material-symbols-outlined">edit</span>
                        </button>
                    </div>
                </div>
                
                <div class="md3-card__content">
                    <!-- Basic Property Information Grid -->
                    <div class="md3-grid md3-grid--4-col md3-mb-6">
                        <div class="md3-info-item">
                            <div class="label-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">{{ t('price') }}</div>
                            {% if land.price %}
                                <div class="title-medium" style="color: var(--md-sys-color-primary);">{{ "{:,.0f}".format(land.price) }}€</div>
                            {% else %}
                                <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Not specified</div>
                            {% endif %}
                        </div>
                        <div class="md3-info-item">
                            <div class="label-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">{{ t('area') }}</div>
                            {% if land.area %}
                                <div class="title-medium">{{ "{:,.0f}".format(land.area) }} m²</div>
                            {% else %}
                                <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Not specified</div>
                            {% endif %}
                        </div>
                        <div class="md3-info-item">
                            <div class="label-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">{{ t('municipality') }}</div>
                            <div class="body-large">{{ land.municipality or 'Unknown' }}</div>
                        </div>
                        <div class="md3-info-item">
                            <div class="label-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">{{ t('type') }}</div>
                            {% if land.land_type %}
                                <span class="md3-chip md3-chip--{{ 'success' if land.land_type == 'developed' else 'warning' }}">
                                    {{ land.land_type.title() }}
                                </span>
                            {% else %}
                                <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Unknown</div>
                            {% endif %}
                        </div>
                    </div>

                    <!-- Location Information -->
                    {% if land.location_lat and land.location_lon %}
                        <div class="md3-mb-6">
                            <div class="label-large" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-2);">{{ t('location') }}</div>
                            <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-3); flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">location_on</span>
                                    <span class="body-medium">{{ "%.6f"|format(land.location_lat) }}, {{ "%.6f"|format(land.location_lon) }}</span>
                                </div>
                                <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}" 
                                   target="_blank" rel="noopener noreferrer" class="md3-button md3-button--outlined">
                                    <span class="material-symbols-outlined">open_in_new</span>
                                    {{ t('view_on_maps') }}
                                </a>
                                {% if land.url %}
                                <a href="{{ land.url }}" 
                                   target="_blank" rel="noopener noreferrer" class="md3-button md3-button--outlined">
                                    <span class="material-symbols-outlined">home</span>
                                    {{ t('view_on_idealista') }}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    {% elif land.municipality %}
                        <div class="md3-mb-6">
                            <div class="label-large" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-2);">{{ t('location') }}</div>
                            <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-3); flex-wrap: wrap;">
                                <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">location_on</span>
                                    <span class="body-medium">{{ land.municipality }}</span>
                                </div>
                                <a href="https://www.google.com/maps/search/{{ land.municipality|urlencode }},+Spain" 
                                   target="_blank" rel="noopener noreferrer" class="md3-button md3-button--outlined">
                                    <span class="material-symbols-outlined">open_in_new</span>
                                    {{ t('view_on_maps') }}
                                </a>
                                {% if land.url %}
                                <a href="{{ land.url }}" 
                                   target="_blank" rel="noopener noreferrer" class="md3-button md3-button--outlined">
                                    <span class="material-symbols-outlined">home</span>
                                    {{ t('view_on_idealista') }}
                                </a>
                                {% endif %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Property Description -->
                    {% if land.description %}
                        <div class="md3-mb-6" id="description-section">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-3);">
                                <div class="label-large" style="color: var(--md-sys-color-on-surface-variant);">{{ t('property_description') }}</div>
                                <div style="display: flex; gap: var(--md-sys-spacing-2);">
                                    <!-- Language Toggle -->
                                    <div class="md3-segmented-button-group" role="group" id="description-language-toggle" style="display: none;">
                                        <button type="button" class="md3-button md3-button--outlined active" data-lang="en">
                                            <span class="material-symbols-outlined">language</span>
                                            {{ t('english') }}
                                        </button>
                                        <button type="button" class="md3-button md3-button--outlined" data-lang="es">
                                            <span class="material-symbols-outlined">language</span>
                                            {{ t('spanish') }}
                                        </button>
                                        <button type="button" class="md3-button md3-button--outlined" data-lang="original">
                                            <span class="material-symbols-outlined">home</span>
                                            {{ t('idealista') }}
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Description Content Card -->
                            <div class="md3-card" id="description-content" style="background-color: var(--md-sys-color-surface-container-highest);">
                                <div class="md3-card__content">
                                    <!-- Enhanced Description -->
                                    <div id="enhanced-description" style="display: none;">
                                        <div class="body-medium" id="enhanced-description-text" style="color: var(--md-sys-color-on-surface);"></div>
                                        <div style="margin-top: var(--md-sys-spacing-3);" id="description-highlights" style="display: none;">
                                            <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">{{ t('key_highlights') }}:</div>
                                            <div id="highlights-list"></div>
                                        </div>
                                        <div style="margin-top: var(--md-sys-spacing-3);" id="price-info-section" style="display: none;">
                                            <div class="body-small">💰 <span id="price-info-text"></span></div>
                                        </div>
                                    </div>
                                    
                                    <!-- Original Description -->
                                    <div id="original-description" class="body-medium">
                                        {{ land.description }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Property Details from Idealista -->
                    {% if land.property_details %}
                        {% if land.property_details is string %}
                            <div class="md3-mb-6">
                                <div class="label-large" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-3);">{{ t('property_details') }}</div>
                                <div class="md3-card" style="background-color: var(--md-sys-color-surface-container-highest);">
                                    <div class="md3-card__content">
                                        <pre class="body-medium" style="white-space: pre-wrap; word-wrap: break-word; margin: 0;">{{ land.property_details }}</pre>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endif %}

                    <!-- AI Analysis Section -->
                    <div id="ai-analysis-section" class="md3-mb-6" style="{{ 'display: block;' if land.ai_analysis else 'display: none;' }}">
                        <div class="md3-card md3-card--elevated">
                            <div class="md3-card__header">
                                <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-3);">
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">psychology</span>
                                    <h3 class="title-medium" style="margin: 0;">{{ t('ai_investment_analysis') }}</h3>
                                </div>
                                <div class="label-small" style="color: var(--md-sys-color-on-surface-variant);">{{ t('powered_by_claude_ai') }}</div>
                            </div>
                            <div class="md3-card__content" id="ai-analysis-content">
                                {% if land.ai_analysis %}
                                    <!-- Display existing AI analysis -->
                                    <div class="analysis-content" id="structured-analysis">
                                        <!-- Content will be populated by JavaScript -->
                                    </div>
                                {% else %}
                                    <!-- Placeholder for new analysis -->
                                    <div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-sys-spacing-8) 0;">
                                        <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: var(--md-sys-spacing-4); opacity: 0.5;">smart_toy</span>
                                        <div class="body-medium">{{ t('click_ai_analysis_button') }}</div>
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div style="display: flex; justify-content: center; gap: var(--md-sys-spacing-3); flex-wrap: wrap;">
                        {% if land.url %}
                            <a href="{{ land.url }}" target="_blank" rel="noopener noreferrer" class="md3-button md3-button--filled">
                                <span class="material-symbols-outlined">home</span>
                                {{ t('view_on_idealista') }}
                            </a>
                        {% endif %}
                        
                        <!-- AI Analysis Button -->
                        <button onclick="analyzeWithClaude({{ land.id }})" 
                                class="md3-button {{ 'md3-button--filled' if land.ai_analysis else 'md3-button--outlined' }}" style="{{ 'background-color: var(--md-sys-color-tertiary); color: var(--md-sys-color-on-tertiary);' if land.ai_analysis else '' }}">
                            <span class="material-symbols-outlined">psychology</span>
                            {{ t('ai_analysis') }}
                        </button>
                        
                        <!-- Google Enrichment Button -->
                        {% set has_enrichment = land.infrastructure_basic or land.infrastructure_extended or land.transport or (land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital) %}
                        <button class="md3-button {{ 'md3-button--filled' if has_enrichment else 'md3-button--outlined' }}" 
                                style="{{ 'background-color: var(--md-sys-color-secondary); color: var(--md-sys-color-on-secondary);' if has_enrichment else '' }}"
                                hx-post="{{ url_for('api.manual_enrichment', land_id=land.id) }}"
                                hx-trigger="click"
                                hx-indicator="#enrichment-spinner">
                            <span class="material-symbols-outlined md3-spinner" style="{{ 'color: var(--md-sys-color-on-secondary);' if has_enrichment else '' }}">sync</span>
                            {{ t('enrich_google_api') }}
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Column -->
        <div class="md3-sidebar-column">
            <!-- Loading indicator for enrichment -->
            <div id="enrichment-spinner" class="htmx-indicator md3-mb-4">
                <div class="md3-card md3-secondary-container">
                    <div class="md3-card__content">
                        <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                            <span class="material-symbols-outlined md3-spinner">sync</span>
                            <span class="body-medium">{{ t('enriching_property_google_api') }}</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Compact Dual Scoring Analysis -->
            {% if land.score_investment or land.score_lifestyle %}
                <div class="md3-card md3-mb-4">
                    <div class="md3-card__content" style="padding: var(--md-sys-spacing-4);">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-3);">
                            <div class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;">
                                <span class="material-symbols-outlined">bar_chart</span>
                                {{ t('scores') }}
                            </div>
                        </div>
                        <div class="md3-grid md3-grid--2-col" style="gap: var(--md-sys-spacing-2);">
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="label-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">attach_money</span>
                                    {{ t('investment') }}
                                </div>
                                <span class="md3-chip md3-chip--warning">{{ "%.0f"|format(land.score_investment or 0) }}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; align-items: center;">
                                <div class="label-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">home</span>
                                    {{ t('lifestyle') }}
                                </div>
                                <span class="md3-chip md3-chip--success">{{ "%.0f"|format(land.score_lifestyle or 0) }}</span>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}

            <!-- Travel Times to Cities & Beaches -->
            {% if land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police or land.distance_airport or land.distance_train_station %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('travel_times_distances') }}">
                            <span class="material-symbols-outlined">map</span>
                            {{ t('travel_times_distances') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        <!-- Travel Time Items -->
                        {% if land.travel_time_airport or land.distance_airport %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-3);">
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);" title="{{ t('nearest_airport') }}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">flight</span>
                                    {{ t('nearest_airport') }}
                                </div>
                                <div style="display: flex; gap: var(--md-sys-spacing-1);">
                                    {% if land.travel_time_airport %}<span class="md3-chip md3-chip--info">{{ land.travel_time_airport }}min</span>{% endif %}
                                    {% if land.distance_airport %}<span class="md3-chip md3-chip--secondary">{{ land.distance_airport }}km</span>{% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if land.travel_time_train_station or land.distance_train_station %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-3);">
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);" title="{{ t('train_station') }}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">train</span>
                                    {{ t('train_station') }}
                                </div>
                                <div style="display: flex; gap: var(--md-sys-spacing-1);">
                                    {% if land.travel_time_train_station %}<span class="md3-chip md3-chip--info">{{ land.travel_time_train_station }}min</span>{% endif %}
                                    {% if land.distance_train_station %}<span class="md3-chip md3-chip--secondary">{{ land.distance_train_station }}km</span>{% endif %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if land.travel_time_hospital or land.distance_hospital %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-3);">
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);" title="{{ t('hospital') }}">
                                    <span class="material-symbols-outlined" style="font-size: 16px;">local_hospital</span>
                                    {{ t('hospital') }}
                                </div>
                                <div style="display: flex; gap: var(--md-sys-spacing-1);">
                                    {% if land.travel_time_hospital %}<span class="md3-chip md3-chip--info">{{ land.travel_time_hospital }}min</span>{% endif %}
                                    {% if land.distance_hospital %}<span class="md3-chip md3-chip--secondary">{{ land.distance_hospital }}km</span>{% endif %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            {% endif %}

            <!-- Infrastructure Basic -->
            {% if land.infrastructure_basic %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('basic_infrastructure') }}">
                            <span class="material-symbols-outlined">build</span>
                            {{ t('basic_infrastructure') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.infrastructure_basic.items() %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                <span class="body-medium">{{ format_field_name(key) }}</span>
                                {% if value is sameas true %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                {% elif value is sameas false %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                {% else %}
                                    <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Infrastructure Extended -->
            {% if land.infrastructure_extended %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('extended_infrastructure') }}">
                            <span class="material-symbols-outlined">apartment</span>
                            {{ t('extended_infrastructure') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.infrastructure_extended.items() %}
                            {% if key == 'osm_amenities' and value is mapping %}
                                <div style="margin-bottom: var(--md-sys-spacing-4);">
                                    <div class="label-medium" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-3);">{{ t('nearby_amenities') }}:</div>
                                    <div>
                                        <!-- Priority Amenities -->
                                        {% for priority_amenity in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                            {% if priority_amenity in value %}
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                                    <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                                        {% if priority_amenity == 'hospital' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-error);">local_hospital</span>
                                                            Hospitals
                                                        {% elif priority_amenity == 'pharmacy' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-primary);">medication</span>
                                                            Pharmacies
                                                        {% elif priority_amenity == 'police' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-secondary);">shield</span>
                                                            Police Stations
                                                        {% elif priority_amenity == 'bank' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-tertiary);">account_balance</span>
                                                            Banks
                                                        {% endif %}
                                                    </div>
                                                    <span class="md3-chip md3-chip--primary">{{ value[priority_amenity] }} nearby</span>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                        
                                        <!-- Separator -->
                                        {% if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) and value.items()|length > (1 if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) else 0) %}
                                            <hr style="border: none; height: 1px; background-color: var(--md-sys-color-outline-variant); margin: var(--md-sys-spacing-2) 0;">
                                        {% endif %}
                                        
                                        <!-- Regular Amenities -->
                                        {% for amenity, count in value.items() %}
                                            {% if amenity not in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                                    <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                                        {% if amenity == 'cafe' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">local_cafe</span>
                                                            Cafes
                                                        {% elif amenity == 'restaurant' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">restaurant</span>
                                                            Restaurants
                                                        {% elif amenity == 'school' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">school</span>
                                                            Schools
                                                        {% elif amenity == 'fuel' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">local_gas_station</span>
                                                            Gas Stations
                                                        {% elif amenity == 'supermarket' %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">shopping_cart</span>
                                                            Supermarkets
                                                        {% else %}
                                                            <span class="material-symbols-outlined" style="font-size: 16px;">place</span>
                                                            {{ format_field_name(amenity) }}
                                                        {% endif %}
                                                    </div>
                                                    <span class="md3-chip md3-chip--primary">{{ count }} nearby</span>
                                                </div>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                {% set base_key = key.replace('_available', '').replace('_distance', '').replace('_travel_time', '') %}
                                {% set has_distance = land.infrastructure_extended.get(base_key + '_distance') if land.infrastructure_extended else None %}
                                {% set has_travel_time = land.infrastructure_extended.get(base_key + '_travel_time') if land.infrastructure_extended else None %}
                                
                                {% if not (has_distance or has_travel_time) or key == base_key + '_available' %}
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                        <span class="body-medium">{{ format_field_name(key) }}</span>
                                        {% if value is sameas true %}
                                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                        {% elif value is sameas false %}
                                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                        {% else %}
                                            <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                        {% endif %}
                                    </div>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Transport Information -->
            {% if land.transport %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('transport') }}">
                            <span class="material-symbols-outlined">directions_bus</span>
                            {{ t('transport') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.transport.items() %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                <span class="body-medium">{{ format_field_name(key) }}</span>
                                {% if value is sameas true %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                {% elif value is sameas false %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                {% else %}
                                    <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Regulatory Information -->
            {% if land.regulatory %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('regulatory') }}">
                            <span class="material-symbols-outlined">gavel</span>
                            {{ t('regulatory') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.regulatory.items() %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                <span class="body-medium">{{ format_field_name(key) }}</span>
                                {% if value is sameas true %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                {% elif value is sameas false %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                {% else %}
                                    <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Land Quality -->
            {% if land.land_quality %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('land_quality') }}">
                            <span class="material-symbols-outlined">landscape</span>
                            {{ t('land_quality') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.land_quality.items() %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                <span class="body-medium">{{ format_field_name(key) }}</span>
                                {% if value is sameas true %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                {% elif value is sameas false %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                {% else %}
                                    <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

            <!-- Environmental Impact -->
            {% if land.environmental_impact %}
                <div class="md3-card md3-mb-6">
                    <div class="md3-card__header">
                        <h3 class="title-medium" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin: 0;" title="{{ t('environmental_impact') }}">
                            <span class="material-symbols-outlined">eco</span>
                            {{ t('environmental_impact') }}
                        </h3>
                    </div>
                    <div class="md3-card__content">
                        {% for key, value in land.environmental_impact.items() %}
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: var(--md-sys-spacing-2);">
                                <span class="body-medium">{{ format_field_name(key) }}</span>
                                {% if value is sameas true %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                {% elif value is sameas false %}
                                    <span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">cancel</span>
                                {% else %}
                                    <span class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            {% endif %}

        </div>
    </div>
</div>


<!-- MD3 Edit Score Modal -->
<div id="editScoreModal" class="md3-modal" style="display: none;">
    <div class="md3-modal-backdrop" onclick="closeScoreModal()"></div>
    <div class="md3-modal-dialog">
        <div class="md3-card">
            <div class="md3-card__header">
                <h2 class="title-large" style="margin: 0;">{{ t('edit_score') }}</h2>
                <button type="button" class="md3-button md3-button--icon" onclick="closeScoreModal()">
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div class="md3-card__content">
                <form method="POST" action="{{ url_for('main.update_score', land_id=land.id) }}">
                    <div style="margin-bottom: var(--md-sys-spacing-4);">
                        <label for="score-input" class="label-medium" style="display: block; margin-bottom: var(--md-sys-spacing-2); color: var(--md-sys-color-on-surface);">{{ t('manual_score_0_100') }}</label>
                        <input type="number" id="score-input" name="score" min="0" max="100" step="0.1" 
                               value="{{ land.score_total if land.score_total else '' }}" 
                               class="md3-text-field" 
                               placeholder="Enter score (0-100)"
                               required>
                    </div>
                    <div style="margin-bottom: var(--md-sys-spacing-4);">
                        <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">{{ t('enter_score_description') }}</div>
                    </div>
                    <div style="display: flex; justify-content: flex-end; gap: var(--md-sys-spacing-3);">
                        <button type="button" class="md3-button md3-button--outlined" onclick="closeScoreModal()">
                            {{ t('cancel') }}
                        </button>
                        <button type="submit" class="md3-button md3-button--filled">
                            <span class="material-symbols-outlined">save</span>
                            {{ t('save_score') }}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Modal functionality
function openScoreModal() {
    const modal = document.getElementById('editScoreModal');
    const scoreInput = document.getElementById('score-input');
    
    if (modal) {
        modal.style.display = 'flex';
        setTimeout(() => {
            modal.classList.add('show');
        }, 10);
        
        // Focus on the input field after modal opens
        setTimeout(() => {
            if (scoreInput) {
                scoreInput.focus();
                scoreInput.select(); // Select existing value for easy editing
            }
        }, 300);
    }
}

function closeScoreModal() {
    const modal = document.getElementById('editScoreModal');
    
    if (modal) {
        modal.classList.remove('show');
        setTimeout(() => {
            modal.style.display = 'none';
        }, 250);
    }
}

// Close modal on Escape key
document.addEventListener('keydown', function(event) {
    if (event.key === 'Escape') {
        closeScoreModal();
    }
});

// Enhanced description setup and AI analysis functionality
document.addEventListener('DOMContentLoaded', function() {
    console.log('[DESC] Setting up description enhancement...');
    
    // Check if we have a description section
    const descSection = document.getElementById('description-section');
    if (!descSection) {
        console.log('[DESC] No description section found, skipping');
        return;
    }
    
    // Initialize existing AI analysis if available
    const existingAnalysis = {{ land.ai_analysis|tojson if land.ai_analysis else 'null' }};
    if (existingAnalysis && typeof existingAnalysis === 'object') {
        console.log('[DESC] Found existing AI analysis, rendering structured content');
        const structuredAnalysisDiv = document.getElementById('structured-analysis');
        if (structuredAnalysisDiv) {
            structuredAnalysisDiv.innerHTML = renderStructuredAIAnalysis(existingAnalysis);
        }
    }
});

// Weight update sliders
document.addEventListener('DOMContentLoaded', function() {
    const weightSliders = [
        'priceWeight', 'locationWeight', 'infrastructureWeight', 'accessibilityWeight'
    ];
    
    weightSliders.forEach(sliderId => {
        const slider = document.getElementById(sliderId);
        const valueSpan = document.getElementById(sliderId + 'Value');
        
        if (slider && valueSpan) {
            slider.addEventListener('input', function() {
                valueSpan.textContent = slider.value;
            });
        }
    });
});

// Update scoring weights function
function updateScoringWeights(landId) {
    const form = document.getElementById('scoring-weights-form');
    const formData = new FormData(form);
    formData.append('land_id', landId);
    
    fetch(form.action, {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Close modal and refresh page to show updated scores
            closeScoreModal();
            location.reload();
        } else {
            alert(data.error || 'Failed to update weights');
        }
    })
    .catch(error => {
        console.error('Error updating weights:', error);
        alert('Network error occurred');
    });
}

// AI Analysis Function
function analyzeWithClaude(landId) {
    console.log('Starting AI analysis for land ID:', landId);
    
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = `<span class="material-symbols-outlined md3-spinner">psychology</span>Analyzing...`;
    
    // Show analysis section
    const analysisSection = document.getElementById('ai-analysis-section');
    analysisSection.style.display = 'block';
    
    const aiContent = document.getElementById('ai-analysis-content');
    
    // Check if we have existing analysis for enrichment
    const existingAnalysis = {{ land.ai_analysis|tojson if land.ai_analysis else 'null' }};
    
    if (existingAnalysis && typeof existingAnalysis === 'object') {
        // For existing analysis, show enrichment overlay
        aiContent.innerHTML = `
            <div class="analysis-content">
                ${renderStructuredAIAnalysis(existingAnalysis)}
                <div class="analysis-loading-overlay" style="position: absolute; top: 0; left: 0; right: 0; bottom: 0; background-color: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; border-radius: var(--md-sys-shape-corner-medium);">
                    <div class="md3-card md3-secondary-container" style="padding: var(--md-sys-spacing-6); text-align: center;">
                        <span class="material-symbols-outlined md3-spinner" style="font-size: 32px; margin-bottom: var(--md-sys-spacing-2);">psychology</span>
                        <div class="body-medium">Enriching existing analysis...</div>
                    </div>
                </div>
            </div>
        `;
    } else {
        // For new analysis, show simple loading
        aiContent.innerHTML = `
            <div style="text-align: center; padding: var(--md-sys-spacing-8) 0;">
                <span class="material-symbols-outlined md3-spinner" style="font-size: 48px; margin-bottom: var(--md-sys-spacing-4);">psychology</span>
                <div class="body-medium">Analyzing property with Claude AI...</div>
                <div class="body-small" style="color: var(--md-sys-color-on-surface-variant); margin-top: var(--md-sys-spacing-2);">This may take a few moments</div>
            </div>
        `;
    }
    
    // Prepare request body
    const requestBody = {};
    if (existingAnalysis) {
        requestBody.existing_analysis = existingAnalysis;
    }
    
    // Call structured analysis API
    fetch(`/api/analyze/property/${landId}/structured`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(requestBody)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Debug: log the response structure
            console.log('AI Analysis Response:', data);
            
            // The analysis data is directly in data.analysis - use it for structured display
            let analysisContent = '';
            
            if (data.analysis && typeof data.analysis === 'object') {
                // Use the structured analysis directly
                analysisContent = renderStructuredAIAnalysis(data.analysis);
            } else {
                // Fallback for non-structured responses
                analysisContent = `<div class="analysis-text">${String(data.analysis).replace(/\n/g, '<br>')}</div>`;
            }
            
            const successText = data.is_enrichment ? 'Analysis enriched successfully!' : 'Analysis completed successfully!';
            
            // For enrichment, smoothly update content, for new analysis, replace entirely
            if (data.is_enrichment) {
                // Remove loading overlay first
                const overlay = aiContent.querySelector('.analysis-loading-overlay');
                if (overlay) {
                    overlay.remove();
                }
                
                // Update existing content with enriched data
                aiContent.innerHTML = `
                    <div class="analysis-content">
                        <div class="md3-card md3-secondary-container" style="margin-bottom: var(--md-sys-spacing-4);" id="success-alert">
                            <div class="md3-card__content" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                <span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">check_circle</span>
                                <span class="body-medium">${successText}</span>
                                <button type="button" onclick="this.parentElement.parentElement.style.display='none'" style="margin-left: auto; background: none; border: none; color: var(--md-sys-color-on-secondary-container);">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                        </div>
                        ${analysisContent}
                    </div>
                `;
            } else {
                // New analysis - replace entirely
                aiContent.innerHTML = `
                    <div class="analysis-content">
                        <div class="md3-card md3-primary-container" style="margin-bottom: var(--md-sys-spacing-4);" id="success-alert">
                            <div class="md3-card__content" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2);">
                                <span class="material-symbols-outlined" style="color: var(--md-sys-color-on-primary-container);">check_circle</span>
                                <span class="body-medium">${successText}</span>
                                <button type="button" onclick="this.parentElement.parentElement.style.display='none'" style="margin-left: auto; background: none; border: none; color: var(--md-sys-color-on-primary-container);">
                                    <span class="material-symbols-outlined">close</span>
                                </button>
                            </div>
                        </div>
                        ${analysisContent}
                    </div>
                `;
            }
            
            // Auto-hide success alert after 3 seconds
            setTimeout(() => {
                const successAlert = document.getElementById('success-alert');
                if (successAlert) {
                    successAlert.style.display = 'none';
                }
            }, 3000);
            
            // Update button to show success state
            button.classList.remove('md3-button--outlined');
            button.classList.add('md3-button--filled');
            button.style.backgroundColor = 'var(--md-sys-color-tertiary)';
            button.style.color = 'var(--md-sys-color-on-tertiary)';
            const buttonText = data.is_enrichment ? 'Analysis Enriched' : 'AI Analysis';
            button.innerHTML = `<span class="material-symbols-outlined">psychology</span>${buttonText}`;
        } else {
            // Display error in the analysis section
            aiContent.innerHTML = `
                <div class="md3-card md3-error-container" style="margin-bottom: var(--md-sys-spacing-4);">
                    <div class="md3-card__content">
                        <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-2);">
                            <span class="material-symbols-outlined" style="color: var(--md-sys-color-on-error-container);">warning</span>
                            <span class="label-large" style="color: var(--md-sys-color-on-error-container);">Analysis Failed</span>
                        </div>
                        <div class="body-medium" style="color: var(--md-sys-color-on-error-container);">${data.error || 'Unknown error occurred'}</div>
                    </div>
                </div>
                <div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-sys-spacing-4) 0;">
                    <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: var(--md-sys-spacing-3); opacity: 0.5;">smart_toy</span>
                    <div class="body-medium">Please try again or contact support if the problem persists</div>
                </div>
            `;
        }
    })
    .catch(error => {
        // Display network error in the analysis section
        aiContent.innerHTML = `
            <div class="md3-card md3-error-container" style="margin-bottom: var(--md-sys-spacing-4);">
                <div class="md3-card__content">
                    <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-2);">
                        <span class="material-symbols-outlined" style="color: var(--md-sys-color-on-error-container);">wifi_off</span>
                        <span class="label-large" style="color: var(--md-sys-color-on-error-container);">Network Error</span>
                    </div>
                    <div class="body-medium" style="color: var(--md-sys-color-on-error-container);">Unable to connect to AI service. Please check your connection and try again.</div>
                </div>
            </div>
            <div style="text-align: center; color: var(--md-sys-color-on-surface-variant); padding: var(--md-sys-spacing-4) 0;">
                <span class="material-symbols-outlined" style="font-size: 48px; margin-bottom: var(--md-sys-spacing-3); opacity: 0.5;">smart_toy</span>
                <div class="body-medium">Connection failed. Please try again in a moment.</div>
            </div>
        `;
    })
    .finally(() => {
        // Restore button (unless it was successful)
        if (!button.classList.contains('md3-button--filled') || !button.style.backgroundColor) {
            button.disabled = false;
            button.innerHTML = originalContent;
        } else {
            button.disabled = false;
        }
    });
}

// Formatting functions for AI analysis
function renderListItems(items, label, colorClass) {
    if (!items || !Array.isArray(items) || items.length === 0) return '';
    
    const listItems = items.map(item => 
        `<li style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-1);"><span class="material-symbols-outlined" style="font-size: 16px; color: var(--md-sys-color-${colorClass});">circle</span>${item}</li>`
    ).join('');
    
    return `<div style="margin-bottom: var(--md-sys-spacing-3);"><div class="label-medium" style="margin-bottom: var(--md-sys-spacing-2);">${label}</div><ul style="list-style: none; padding: 0; margin: 0;">${listItems}</ul></div>`;
}

function renderSimilarProperties(similarProperties) {
    if (!similarProperties || !Array.isArray(similarProperties) || similarProperties.length === 0) {
        return '<div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">No similar properties found</div>';
    }
    
    const propertyCards = similarProperties.map(prop => {
        const priceText = prop.price ? `€${prop.price.toLocaleString()}` : 'Price N/A';
        const areaText = prop.area ? `${prop.area.toLocaleString()}m²` : 'Area N/A';
        const scoreText = prop.score_total ? `${prop.score_total.toFixed(1)}/100` : 'Not scored';
        
        const landTypeClass = prop.land_type === 'developed' ? 'md3-chip--success' : 'md3-chip--warning';
        
        return `
            <div class="md3-card" style="margin-bottom: var(--md-sys-spacing-3); background-color: var(--md-sys-color-surface-container);">
                <div class="md3-card__content">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: var(--md-sys-spacing-3);">
                        <div style="flex: 1;">
                            <h6 class="title-small" style="margin-bottom: var(--md-sys-spacing-1);">
                                <a href="/lands/${prop.id}" class="md3-link">
                                    ${prop.title ? prop.title.substring(0, 50) + (prop.title.length > 50 ? '...' : '') : 'Property #' + prop.id}
                                </a>
                            </h6>
                            <div style="display: flex; flex-wrap: wrap; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-2);">
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);"><span class="material-symbols-outlined" style="font-size: 14px;">euro</span>${priceText}</div>
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);"><span class="material-symbols-outlined" style="font-size: 14px;">straighten</span>${areaText}</div>
                                <div class="body-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);"><span class="material-symbols-outlined" style="font-size: 14px;">location_on</span>${prop.municipality || 'Location N/A'}</div>
                            </div>
                        </div>
                        <div style="text-align: end;">
                            <span class="md3-chip ${landTypeClass}">${(prop.land_type || 'Unknown').charAt(0).toUpperCase() + (prop.land_type || 'unknown').slice(1)}</span>
                            <div class="body-small" style="margin-top: var(--md-sys-spacing-1); display: flex; align-items: center; gap: var(--md-sys-spacing-1);">
                                <span class="material-symbols-outlined" style="font-size: 14px;">star</span>${scoreText}
                            </div>
                        </div>
                    </div>
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div style="display: flex; gap: var(--md-sys-spacing-2);">
                            <a href="/lands/${prop.id}" class="md3-button md3-button--filled">
                                <span class="material-symbols-outlined">visibility</span>View Details
                            </a>
                            ${prop.url ? `<a href="${prop.url}" target="_blank" class="md3-button md3-button--outlined">
                                <span class="material-symbols-outlined">open_in_new</span>Idealista
                            </a>` : ''}
                        </div>
                        <div class="label-small" style="color: var(--md-sys-color-on-surface-variant);">Similar property</div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
    
    return propertyCards;
}

function getPriceVerdictClass(verdict) {
    switch(verdict) {
        case 'Fair Price': return 'md3-chip--success';
        case 'Underpriced': return 'md3-chip--primary';
        case 'Overpriced': return 'md3-chip--error';
        default: return 'md3-chip--secondary';
    }
}

function getPriceTrendClass(trend) {
    switch(trend) {
        case 'RISING': return 'md3-chip--success';
        case 'STABLE': return 'md3-chip--info';
        case 'DECLINING': return 'md3-chip--error';
        default: return 'md3-chip--secondary';
    }
}

function formatUIText(value) {
    if (!value) return 'Unknown';
    // Convert values for better UI display
    const formatMap = {
        'HIGH': 'High',
        'MEDIUM': 'Medium', 
        'LOW': 'Low',
        'RISING': 'Rising',
        'STABLE': 'Stable',
        'DECLINING': 'Declining',
        'EXCELLENT': 'Excellent',
        // Prevent legacy artifacts
        'FAIR_PRICE': 'Good Value',
        'UNDERPRICED': 'Good Value',
        'OVERPRICED': 'Overpriced',
        'GOOD': 'Good',
        'MODERATE': 'Moderate',
        'BELOW AVERAGE': 'Below Average'
    };
    return formatMap[value] || value;
}

// Render structured AI analysis
function renderStructuredAIAnalysis(analysis) {
    console.log('Rendering analysis with structure:', Object.keys(analysis || {}));
    
    // Safety check for empty analysis
    if (!analysis || typeof analysis !== 'object') {
        return '<div class="md3-card md3-error-container"><div class="md3-card__content"><div class="body-medium">No analysis data available</div></div></div>';
    }
    
    try {
        return `
            <div class="md3-grid md3-grid--2-col" style="margin-bottom: var(--md-sys-spacing-4);">
                <div class="md3-card" style="height: 100%;">
                    <div class="md3-card__content">
                        <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">euro</span>Price Analysis</h6>
                        ${analysis.price_analysis ? `
                            <span class="md3-chip ${getPriceVerdictClass(analysis.price_analysis.verdict)}" style="margin-bottom: var(--md-sys-spacing-2);">
                                ${formatUIText(analysis.price_analysis.verdict)}
                            </span>
                            <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);">${analysis.price_analysis.summary || 'No analysis available'}</div>
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">${analysis.price_analysis.recommendation || ''}</div>
                        ` : `
                            <span class="md3-chip md3-chip--secondary" style="margin-bottom: var(--md-sys-spacing-2);">Analysis Pending</span>
                            <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Price analysis will be available after next AI enrichment</div>
                        `}
                    </div>
                </div>
                
                <div class="md3-card" style="height: 100%;">
                    <div class="md3-card__content">
                        <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">trending_up</span>Investment Potential</h6>
                        ${analysis.investment_potential ? `
                            <span class="md3-chip ${getInvestmentRatingClass(analysis.investment_potential.rating)}" style="margin-bottom: var(--md-sys-spacing-2);">
                                ${formatUIText(analysis.investment_potential.rating)} Growth
                            </span>
                            <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);">${analysis.investment_potential.forecast || 'No forecast available'}</div>
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Risk: ${formatUIText(analysis.investment_potential.risk_level)}</div>
                            ${analysis.investment_potential.key_drivers ? renderListItems(analysis.investment_potential.key_drivers, 'Key Drivers:', 'tertiary') : ''}
                        ` : `
                            <span class="md3-chip md3-chip--secondary" style="margin-bottom: var(--md-sys-spacing-2);">Analysis Pending</span>
                            <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Investment analysis will be available after next AI enrichment</div>
                        `}
                    </div>
                </div>
            </div>
            
            <div class="md3-grid md3-grid--2-col" style="margin-bottom: var(--md-sys-spacing-4);">
                <div class="md3-card" style="height: 100%;">
                    <div class="md3-card__content">
                        <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-error);">warning</span>Risks & Advantages</h6>
                        ${analysis.risks_analysis ? `
                            ${renderListItems(analysis.risks_analysis.major_risks, 'Risks:', 'error')}
                            ${renderListItems(analysis.risks_analysis.advantages, 'Advantages:', 'primary')}
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">${analysis.risks_analysis.mitigation || ''}</div>
                        ` : analysis.comparable_analysis ? `
                            ${renderListItems(analysis.comparable_analysis.advantages_vs_similar, 'Advantages:', 'primary')}
                            ${renderListItems(analysis.comparable_analysis.disadvantages_vs_similar, 'Disadvantages:', 'error')}
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Based on market comparison data</div>
                        ` : `
                            <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Risk analysis will be available after next AI enrichment</div>
                        `}
                    </div>
                </div>
                
                <div class="md3-card" style="height: 100%;">
                    <div class="md3-card__content">
                        <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-tertiary);">construction</span>Development Ideas</h6>
                        ${analysis.development_ideas ? `
                            <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);"><strong>${analysis.development_ideas.best_use || 'No recommendations'}</strong></div>
                            <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);">${analysis.development_ideas.building_size || ''}</div>
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">${analysis.development_ideas.estimated_cost || ''}</div>
                            ${analysis.development_ideas.special_features ? `<div style="margin-top: var(--md-sys-spacing-2);"><div class="body-small" style="color: var(--md-sys-color-tertiary);">${analysis.development_ideas.special_features}</div></div>` : ''}
                        ` : `
                            <div class="body-medium" style="color: var(--md-sys-color-on-surface-variant);">Development ideas will be available after next AI enrichment</div>
                        `}
                    </div>
                </div>
            </div>
            
            ${analysis.comparable_analysis ? `
            <div class="md3-card" style="margin-bottom: var(--md-sys-spacing-4);">
                <div class="md3-card__content">
                    <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-secondary);">balance</span>Market Comparison</h6>
                    <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);">${analysis.comparable_analysis.market_position || 'No comparison data'}</div>
                    <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">${analysis.comparable_analysis.price_comparison || ''}</div>
                </div>
            </div>
            ` : ''}
            
            ${analysis.construction_value_estimation ? `
            <div class="md3-card" style="margin-bottom: var(--md-sys-spacing-4);">
                <div class="md3-card__content">
                    <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">calculate</span>Construction Value Estimation</h6>
                    <div class="md3-grid md3-grid--3-col">
                        <div>
                            <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Construction Type</div>
                            <div class="body-medium">${analysis.construction_value_estimation.construction_type || 'Standard construction'}</div>
                        </div>
                        <div>
                            <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Est. Construction Value</div>
                            <div class="body-medium">€${(analysis.construction_value_estimation.minimum_value || 0).toLocaleString()} - €${(analysis.construction_value_estimation.maximum_value || 0).toLocaleString()}</div>
                        </div>
                        <div>
                            <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Total Investment</div>
                            <div class="body-medium" style="color: var(--md-sys-color-primary);">${analysis.construction_value_estimation.total_investment || 'N/A'}</div>
                        </div>
                    </div>
                </div>
            </div>
        ` : ''}
        
        <!-- Market Price Dynamics Section -->
        ${analysis.market_price_dynamics ? `
        <div class="md3-card" style="margin-bottom: var(--md-sys-spacing-4);">
            <div class="md3-card__content">
                <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">trending_up</span>Market Price Dynamics</h6>
                <div style="margin-bottom: var(--md-sys-spacing-3);">
                    <span class="md3-chip ${getPriceTrendClass(analysis.market_price_dynamics.price_trend || analysis.market_price_dynamics.current_trend)}" style="margin-right: var(--md-sys-spacing-2);">${formatUIText(analysis.market_price_dynamics.price_trend || analysis.market_price_dynamics.current_trend)} Trend</span>
                    <span class="md3-chip md3-chip--info">${analysis.market_price_dynamics.annual_growth_rate || analysis.market_price_dynamics.annual_appreciation || 'N/A'}% annually</span>
                </div>
                <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-3);">${analysis.market_price_dynamics.trend_analysis || 'No trend analysis available'}</div>
                ${analysis.market_price_dynamics.market_factors ? renderListItems(analysis.market_price_dynamics.market_factors, 'Market Factors:', 'primary') : ''}
                <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">${analysis.market_price_dynamics.future_outlook || ''}</div>
            </div>
        </div>
        ` : ''}
        
        <!-- Rental Market Analysis Section -->
        ${analysis.rental_market_analysis ? `
        <div class="md3-card" style="margin-bottom: var(--md-sys-spacing-4);">
            <div class="md3-card__content">
                <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-tertiary);">key</span>Rental Market Analysis</h6>
                
                <div class="md3-grid md3-grid--2-col" style="margin-bottom: var(--md-sys-spacing-4);">
                    <div class="md3-card md3-card--outlined">
                        <div class="md3-card__content">
                            <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined">attach_money</span>Rental Income Estimates</h6>
                            <div class="md3-grid md3-grid--3-col" style="text-align: center; margin-bottom: var(--md-sys-spacing-3);">
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Min Monthly</div>
                                    <div class="body-medium">€${(analysis.rental_market_analysis.monthly_rent_min || 0).toLocaleString()}</div>
                                </div>
                                <div class="md3-primary-container" style="border-radius: var(--md-sys-shape-corner-small); padding: var(--md-sys-spacing-2);">
                                    <div class="label-small" style="margin-bottom: var(--md-sys-spacing-1);">Avg Monthly</div>
                                    <div class="body-medium">€${(analysis.rental_market_analysis.monthly_rent_avg || 0).toLocaleString()}</div>
                                </div>
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Max Monthly</div>
                                    <div class="body-medium">€${(analysis.rental_market_analysis.monthly_rent_max || 0).toLocaleString()}</div>
                                </div>
                            </div>
                            <div class="body-medium" style="margin-bottom: var(--md-sys-spacing-2);"><strong>Annual Income:</strong> €${(analysis.rental_market_analysis.annual_rent_avg || 0).toLocaleString()}/year</div>
                            <div class="body-small" style="color: var(--md-sys-color-on-surface-variant);">Strategy: ${analysis.rental_market_analysis.rental_strategy || 'Long-term rental'}</div>
                        </div>
                    </div>
                    
                    <div class="md3-card md3-card--outlined">
                        <div class="md3-card__content">
                            <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined">pie_chart</span>Investment Metrics</h6>
                            <div class="md3-grid md3-grid--2-col" style="margin-bottom: var(--md-sys-spacing-3);">
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Rental Yield</div>
                                    <div style="display: flex; align-items: center; gap: var(--md-sys-spacing-1);">
                                        <div class="body-medium" style="color: ${(analysis.rental_market_analysis.rental_yield && analysis.rental_market_analysis.rental_yield > 5) ? 'var(--md-sys-color-primary)' : (analysis.rental_market_analysis.rental_yield && analysis.rental_market_analysis.rental_yield > 4) ? 'var(--md-sys-color-secondary)' : 'var(--md-sys-color-on-surface)'}">${analysis.rental_market_analysis.rental_yield || 'N/A'}%</div>
                                        <div class="label-small" style="color: var(--md-sys-color-on-surface-variant);">/year</div>
                                    </div>
                                </div>
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Cap Rate</div>
                                    <div class="body-medium" style="color: ${(analysis.rental_market_analysis.cap_rate && analysis.rental_market_analysis.cap_rate > 4) ? 'var(--md-sys-color-primary)' : (analysis.rental_market_analysis.cap_rate && analysis.rental_market_analysis.cap_rate > 3) ? 'var(--md-sys-color-secondary)' : 'var(--md-sys-color-on-surface)'}">${analysis.rental_market_analysis.cap_rate || 'N/A'}%</div>
                                </div>
                            </div>
                            <div class="md3-grid md3-grid--2-col" style="margin-bottom: var(--md-sys-spacing-3);">
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Price/Rent Ratio</div>
                                    <div class="body-medium">${analysis.rental_market_analysis.price_to_rent_ratio || 'N/A'}</div>
                                </div>
                                <div>
                                    <div class="label-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-1);">Payback Period</div>
                                    <div class="body-medium">${analysis.rental_market_analysis.payback_period_years || 'N/A'} years</div>
                                </div>
                            </div>
                            <div>
                                <span class="md3-chip ${getInvestmentRatingClass(analysis.rental_market_analysis.investment_rating)}">${analysis.rental_market_analysis.investment_rating || 'Not rated'}</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                ${analysis.rental_market_analysis.demand_factors ? `
                <div class="md3-card md3-card--outlined">
                    <div class="md3-card__content">
                        <div class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-2);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-tertiary);">trending_up</span>Rental Demand Factors:</div>
                        ${renderListItems(analysis.rental_market_analysis.demand_factors, '', 'tertiary')}
                    </div>
                </div>
                ` : ''}
            </div>
        </div>
        ` : ''}
        
        <!-- Similar Objects - Additional Information -->
        ${analysis.similar_objects ? `
        <div class="md3-card" style="margin-top: var(--md-sys-spacing-6); background-color: var(--md-sys-color-surface-container-highest);">
            <div class="md3-card__content">
                <h6 class="title-small" style="display: flex; align-items: center; gap: var(--md-sys-spacing-2); margin-bottom: var(--md-sys-spacing-3);"><span class="material-symbols-outlined" style="color: var(--md-sys-color-primary);">link</span>Similar Objects</h6>
                <div class="body-small" style="color: var(--md-sys-color-on-surface-variant); margin-bottom: var(--md-sys-spacing-4);">${analysis.similar_objects.comparison_summary || 'Similar properties from our database:'}</div>
                ${renderSimilarProperties(analysis.similar_properties_data || [])}
            </div>
        </div>
        ` : ''}
    `;
    } catch (renderError) {
        console.error('Template rendering error:', renderError);
        return '<div class="md3-card md3-error-container"><div class="md3-card__content"><div class="body-medium">Error rendering analysis template. Please refresh the page.</div></div></div>';
    }
}

// Helper function for investment rating badge color (consolidated version)
function getInvestmentRatingClass(rating) {
    if (!rating) return 'md3-chip--secondary';
    
    // Convert to uppercase for comparison
    const upperRating = String(rating).toUpperCase();
    
    // Check for both styles of ratings
    if (upperRating.includes('HIGH') || upperRating.includes('EXCELLENT') || upperRating === 'A') {
        return 'md3-chip--success';
    } else if (upperRating.includes('MEDIUM') || upperRating.includes('GOOD') || upperRating === 'B') {
        return 'md3-chip--warning';
    } else if (upperRating.includes('LOW') || upperRating.includes('POOR') || upperRating === 'C') {
        return 'md3-chip--error';
    } else {
        return 'md3-chip--secondary';
    }
}

function getPriceToRentClass(ratio) {
    if (!ratio) return '';
    const numRatio = parseFloat(ratio);
    if (numRatio <= 15) return 'text-success';
    if (numRatio <= 25) return 'text-warning';
    return 'text-danger';
}

function getPaybackPeriodClass(years) {
    if (!years) return '';
    const numYears = parseFloat(years);
    if (numYears <= 15) return 'text-success';
    if (numYears <= 25) return 'text-warning';  
    return 'text-danger';
}
</script>

<style>
/* MD3 Custom Components and Utilities */
.md3-chip {
    display: inline-flex;
    align-items: center;
    gap: var(--md-sys-spacing-1);
    padding: var(--md-sys-spacing-1) var(--md-sys-spacing-3);
    border-radius: var(--md-sys-shape-corner-full);
    font: var(--md-sys-typescale-label-small);
    border: 1px solid var(--md-sys-color-outline);
    background-color: var(--md-sys-color-surface-container-highest);
    color: var(--md-sys-color-on-surface);
    transition: all 200ms ease;
}

.md3-chip--primary {
    background-color: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    border-color: var(--md-sys-color-primary);
}

.md3-chip--success {
    background-color: color-mix(in srgb, #4caf50 20%, var(--md-sys-color-surface));
    color: #2e7d32;
    border-color: #4caf50;
}

.md3-chip--warning {
    background-color: color-mix(in srgb, #ff9800 20%, var(--md-sys-color-surface));
    color: #f57c00;
    border-color: #ff9800;
}

.md3-chip--error {
    background-color: var(--md-sys-color-error-container);
    color: var(--md-sys-color-on-error-container);
    border-color: var(--md-sys-color-error);
}

.md3-chip--secondary {
    background-color: var(--md-sys-color-secondary-container);
    color: var(--md-sys-color-on-secondary-container);
    border-color: var(--md-sys-color-secondary);
}

.md3-chip--info {
    background-color: color-mix(in srgb, #2196f3 20%, var(--md-sys-color-surface));
    color: #1976d2;
    border-color: #2196f3;
}

.md3-link {
    color: var(--md-sys-color-primary);
    text-decoration: none;
    transition: color 200ms ease;
}

.md3-link:hover {
    color: var(--md-sys-color-primary);
    text-decoration: underline;
}

.md3-segmented-button-group {
    display: flex;
    border-radius: var(--md-sys-shape-corner-full);
    overflow: hidden;
}

.md3-segmented-button-group .md3-button {
    border-radius: 0;
    border-right: none;
}

.md3-segmented-button-group .md3-button:first-child {
    border-radius: var(--md-sys-shape-corner-full) 0 0 var(--md-sys-shape-corner-full);
}

.md3-segmented-button-group .md3-button:last-child {
    border-radius: 0 var(--md-sys-shape-corner-full) var(--md-sys-shape-corner-full) 0;
    border-right: 1px solid var(--md-sys-color-outline);
}

/* MD3 Modal Styles */
.md3-modal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    z-index: 1000;
    display: flex;
    align-items: center;
    justify-content: center;
    opacity: 0;
    visibility: hidden;
    transition: all 250ms ease;
}

.md3-modal.show {
    opacity: 1;
    visibility: visible;
}

.md3-modal-backdrop {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.5);
    backdrop-filter: blur(2px);
}

.md3-modal-dialog {
    position: relative;
    max-width: 500px;
    width: 90%;
    max-height: 90vh;
    overflow-y: auto;
    transform: scale(0.8);
    transition: transform 250ms ease;
}

.md3-modal.show .md3-modal-dialog {
    transform: scale(1);
}

.md3-modal .md3-card__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--md-sys-spacing-6);
    border-bottom: 1px solid var(--md-sys-color-outline-variant);
}

.md3-modal .md3-card__content {
    padding: var(--md-sys-spacing-6);
}

.md3-text-field {
    width: 100%;
    padding: var(--md-sys-spacing-3) var(--md-sys-spacing-4);
    border: 1px solid var(--md-sys-color-outline);
    border-radius: var(--md-sys-shape-corner-extra-small);
    background-color: var(--md-sys-color-surface);
    color: var(--md-sys-color-on-surface);
    font: var(--md-sys-typescale-body-large);
    transition: border-color 200ms ease, box-shadow 200ms ease;
}

.md3-text-field:focus {
    outline: none;
    border-color: var(--md-sys-color-primary);
    box-shadow: 0 0 0 2px color-mix(in srgb, var(--md-sys-color-primary) 20%, transparent);
}

/* Responsive adjustments */
@media (max-width: 1024px) {
    .md3-grid[style*="grid-template-columns: 2fr 1fr"] {
        grid-template-columns: 1fr !important;
    }
    
    .md3-grid--4-col {
        grid-template-columns: repeat(2, 1fr) !important;
    }
    
    .md3-modal-dialog {
        max-width: 95%;
        margin: var(--md-sys-spacing-4);
    }
}

@media (max-width: 768px) {
    .md3-container {
        padding: 0 var(--md-sys-spacing-4);
    }
    
    .md3-page-header [style*="flex-wrap"] {
        flex-wrap: wrap !important;
    }
    
    .md3-grid--2-col,
    .md3-grid--3-col,
    .md3-grid--4-col {
        grid-template-columns: 1fr !important;
    }
}
</style>
{% endblock %}