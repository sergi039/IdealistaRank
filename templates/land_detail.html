{% extends "base.html" %}

{% block title %}{{ land.title }} - Idealista Land Watch{% endblock %}

{% block content %}
<div class="row">
    <div class="col-12 mb-4">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="mb-0">
                <i class="fas fa-map-marker-alt me-2"></i>
                {{ land.title[:60] }}{% if land.title|length > 60 %}...{% endif %}
            </h1>
            <a href="{{ url_for('main.lands') }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-1"></i>Back to Properties
            </a>
        </div>
    </div>
</div>

<div class="row">
    <!-- Main Info -->
    <div class="col-lg-8">
        <div class="card mb-4">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h2 class="card-title mb-0">{{ land.title }}</h2>
                <div class="d-flex align-items-center gap-2">
                    {% if land.score_total %}
                        <span class="badge score-badge fs-5" 
                              style="background-color: {{ 'var(--bs-success)' if land.score_total >= 70 else 'var(--bs-warning)' if land.score_total >= 50 else 'var(--bs-danger)' }}">
                            Score: {{ "%.1f"|format(land.score_total) }}
                        </span>
                    {% endif %}
                    <button type="button" class="btn btn-sm btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#editScoreModal">
                        <i class="fas fa-edit"></i>
                    </button>
                </div>
            </div>
            <div class="card-body">
                <!-- Basic Info -->
                <div class="row mb-4">
                    <div class="col-md-3">
                        <strong>Price:</strong><br>
                        {% if land.price %}
                            <span class="fs-4 text-success">{{ "{:,.0f}".format(land.price) }}€</span>
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <strong>Area:</strong><br>
                        {% if land.area %}
                            <span class="fs-5">{{ "{:,.0f}".format(land.area) }} m²</span>
                        {% else %}
                            <span class="text-muted">Not specified</span>
                        {% endif %}
                    </div>
                    <div class="col-md-3">
                        <strong>Municipality:</strong><br>
                        <span class="fs-6">{{ land.municipality or 'Unknown' }}</span>
                    </div>
                    <div class="col-md-3">
                        <strong>Type:</strong><br>
                        {% if land.land_type %}
                            <span class="badge {{ 'bg-success' if land.land_type == 'developed' else 'bg-warning' }} fs-6">
                                {{ land.land_type.title() }}
                            </span>
                        {% else %}
                            <span class="text-muted">Unknown</span>
                        {% endif %}
                    </div>
                </div>

                <!-- Location -->
                {% if land.location_lat and land.location_lon %}
                    <div class="mb-4">
                        <strong>Location:</strong><br>
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ "%.6f"|format(land.location_lat) }}, {{ "%.6f"|format(land.location_lon) }}
                        <a href="https://www.google.com/maps/search/?api=1&query={{ land.location_lat }},{{ land.location_lon }}" 
                           target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="fas fa-external-link-alt me-1"></i>View on Maps
                        </a>
                    </div>
                {% elif land.municipality %}
                    <div class="mb-4">
                        <strong>Location:</strong><br>
                        <i class="fas fa-map-marker-alt me-2"></i>
                        {{ land.municipality }}
                        <a href="https://www.google.com/maps/search/{{ land.municipality|urlencode }},+Spain" 
                           target="_blank" class="btn btn-sm btn-outline-primary ms-2">
                            <i class="fas fa-external-link-alt me-1"></i>View on Maps
                        </a>
                    </div>
                {% endif %}

                <!-- Brief Description -->
                {% if land.description %}
                    <div class="mb-4">
                        <strong>Brief Description:</strong>
                        <div class="mt-2 p-3 bg-dark rounded">
                            {{ land.description }}
                        </div>
                    </div>
                {% endif %}
                
                <!-- Property Details from Idealista -->
                {% if land.property_details %}
                    <div class="mb-4">
                        <strong>Property Details:</strong>
                        <div class="mt-2 p-3 bg-dark rounded">
                            <pre class="text-light mb-0" style="white-space: pre-wrap; word-wrap: break-word;">{{ land.property_details }}</pre>
                        </div>
                    </div>
                {% endif %}

                <!-- Actions -->
                <div class="mt-4">
                    {% if land.url %}
                        <a href="{{ land.url }}" target="_blank" class="btn btn-success btn-lg">
                            <i class="fas fa-home me-2"></i>
                            View on Idealista
                        </a>
                    {% endif %}
                    <button onclick="analyzeWithClaude({{ land.id }})" class="btn btn-info">
                        <i class="fas fa-brain me-2"></i>
                        AI Analysis
                    </button>
                    <a href="{{ url_for('main.edit_environment', land_id=land.id) }}" class="btn btn-primary">
                        <i class="fas fa-edit me-2"></i>
                        Edit Environment
                    </a>
                </div>
            </div>
        </div>

        <!-- Score Breakdown -->
        {% if score_breakdown %}
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Score Breakdown
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        {% for criteria, score in score_breakdown.items() %}
                            {% if score is not none %}
                                <div class="col-md-6 mb-3">
                                    <div class="d-flex justify-content-between align-items-center mb-1">
                                        <span class="fw-bold">{{ criteria.replace('_', ' ').title() }}</span>
                                        <span class="badge bg-secondary">{{ "%.1f"|format(score) }}</span>
                                    </div>
                                    <div class="progress">
                                        <div class="progress-bar" 
                                             style="width: {{ score }}%; background-color: {{ 'var(--bs-success)' if score >= 70 else 'var(--bs-warning)' if score >= 50 else 'var(--bs-danger)' }};">
                                        </div>
                                    </div>
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endif %}
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Infrastructure Basic -->
        {% if land.infrastructure_basic %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-tools me-2"></i>Basic Infrastructure
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.infrastructure_basic.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span>{{ key.replace('_', ' ').title() }}</span>
                            {% if value is sameas true %}
                                <i class="fas fa-check-circle text-success"></i>
                            {% elif value is sameas false %}
                                <i class="fas fa-times-circle text-danger"></i>
                            {% else %}
                                <span class="text-muted">{{ value }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Infrastructure Extended -->
        {% if land.infrastructure_extended %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-building me-2"></i>Extended Infrastructure
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.infrastructure_extended.items() %}
                        {% if key == 'osm_amenities' and value is mapping %}
                            <div class="mb-3">
                                <span class="small fw-bold">Nearby Amenities:</span>
                                <div class="mt-2">
                                    <!-- Priority Amenities (Top of list) -->
                                    {% for priority_amenity in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                        {% if priority_amenity in value %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small text-capitalize fw-bold">
                                                    {% if priority_amenity == 'hospital' %}
                                                        <i class="fas fa-hospital me-1 text-danger"></i> Hospitals
                                                    {% elif priority_amenity == 'pharmacy' %}
                                                        <i class="fas fa-pills me-1 text-success"></i> Pharmacies
                                                    {% elif priority_amenity == 'police' %}
                                                        <i class="fas fa-shield-alt me-1 text-primary"></i> Police Stations
                                                    {% elif priority_amenity == 'bank' %}
                                                        <i class="fas fa-university me-1 text-info"></i> Banks
                                                    {% endif %}
                                                </span>
                                                <span class="badge bg-primary">{{ value[priority_amenity] }}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                    
                                    <!-- Separator if we have priority amenities -->
                                    {% if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) and value.items()|length > (1 if (value.get('hospital') or value.get('pharmacy') or value.get('police') or value.get('bank')) else 0) %}
                                        <hr class="my-2">
                                    {% endif %}
                                    
                                    <!-- Regular Amenities -->
                                    {% for amenity, count in value.items() %}
                                        {% if amenity not in ['hospital', 'pharmacy', 'police', 'bank'] %}
                                            <div class="d-flex justify-content-between align-items-center mb-1">
                                                <span class="small text-capitalize">
                                                    {% if amenity == 'cafe' %}
                                                        <i class="fas fa-coffee me-1"></i> Cafes
                                                    {% elif amenity == 'restaurant' %}
                                                        <i class="fas fa-utensils me-1"></i> Restaurants
                                                    {% elif amenity == 'school' %}
                                                        <i class="fas fa-graduation-cap me-1"></i> Schools
                                                    {% elif amenity == 'fuel' %}
                                                        <i class="fas fa-gas-pump me-1"></i> Gas Stations
                                                    {% elif amenity == 'supermarket' %}
                                                        <i class="fas fa-shopping-cart me-1"></i> Supermarkets
                                                    {% else %}
                                                        <i class="fas fa-map-marker-alt me-1"></i> {{ amenity.replace('_', ' ').title() }}
                                                    {% endif %}
                                                </span>
                                                <span class="badge bg-primary">{{ count }}</span>
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            </div>
                        {% else %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                {% if value is sameas true %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% elif value is sameas false %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% elif value is number %}
                                    {% set distance_km = value/1000 %}
                                    {% set travel_time_min = (distance_km * 60 / 40)|round %}
                                    <div>
                                        <span class="badge bg-secondary me-1">{{ "%.1f"|format(distance_km) }}km</span>
                                        <span class="badge bg-info">~{{ travel_time_min }}min</span>
                                    </div>
                                {% elif value is mapping %}
                                    <!-- Handle other dictionary values -->
                                    <div class="small">
                                        {% for k, v in value.items() %}
                                            <div>{{ k }}: {{ v }}</div>
                                        {% endfor %}
                                    </div>
                                {% else %}
                                    <span class="text-muted small">{{ value }}</span>
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Transport -->
        {% if land.transport or land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-route me-2"></i>Transport
                    </h6>
                </div>
                <div class="card-body">
                    <!-- Priority Infrastructure (Top of list) -->
                    {% if land.transport and land.transport.get('airport_available') == false %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-plane me-1"></i>Airport</span>
                            <div>
                                <i class="fas fa-times-circle text-danger"></i>
                                <small class="text-muted ms-1">Not available</small>
                            </div>
                        </div>
                    {% elif land.travel_time_airport %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-plane me-1"></i>Airport</span>
                            <div>
                                <span class="badge bg-info me-1">{{ land.travel_time_airport }}min</span>
                                {% if land.distance_airport %}<span class="badge bg-secondary">{{ land.distance_airport }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_train_station %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-train me-1"></i>Train Station</span>
                            <div>
                                <span class="badge bg-info me-1">{{ land.travel_time_train_station }}min</span>
                                {% if land.distance_train_station %}<span class="badge bg-secondary">{{ land.distance_train_station }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_hospital %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-hospital me-1"></i>Hospital</span>
                            <div>
                                <span class="badge bg-info me-1">{{ land.travel_time_hospital }}min</span>
                                {% if land.distance_hospital %}<span class="badge bg-secondary">{{ land.distance_hospital }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    {% if land.travel_time_police %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small fw-bold"><i class="fas fa-shield-alt me-1"></i>Police Station</span>
                            <div>
                                <span class="badge bg-info me-1">{{ land.travel_time_police }}min</span>
                                {% if land.distance_police %}<span class="badge bg-secondary">{{ land.distance_police }}km</span>{% endif %}
                            </div>
                        </div>
                    {% endif %}
                    
                    <!-- Separator if we have both priority and regular transport data -->
                    {% if (land.travel_time_airport or land.travel_time_train_station or land.travel_time_hospital or land.travel_time_police) and land.transport %}
                        <hr class="my-3">
                    {% endif %}
                    
                    <!-- Regular Transport Data -->
                    {% if land.transport %}
                        {% for key, value in land.transport.items() %}
                            {% if not (key.endswith('_travel_time') and (key.replace('_travel_time', '_distance') in land.transport)) and not (key.endswith('_available') and (key.replace('_available', '_distance') in land.transport)) %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                {% if value is sameas true %}
                                    <i class="fas fa-check-circle text-success"></i>
                                {% elif value is sameas false %}
                                    <i class="fas fa-times-circle text-danger"></i>
                                {% elif value is number and 'distance' in key %}
                                    <div>
                                        {% set transport_type = key.replace('_distance', '') %}
                                        {% if land.transport.get(transport_type + '_travel_time') %}
                                            <span class="badge bg-info me-1">{{ land.transport[transport_type + '_travel_time'] }}min</span>
                                        {% endif %}
                                        {% if value < 1000 %}
                                            <span class="badge bg-secondary">{{ "%.1f"|format(value/1000) }}km</span>
                                        {% else %}
                                            <span class="badge bg-secondary">{{ "%.0f"|format(value/1000) }}km</span>
                                        {% endif %}
                                    </div>
                                {% elif value is number and 'duration' in key %}
                                    <span class="badge bg-info">{{ "%.0f"|format(value/60) }}min</span>
                                {% else %}
                                    <span class="text-muted small">{{ value }}</span>
                                {% endif %}
                            </div>
                            {% endif %}
                        {% endfor %}
                    {% endif %}
                </div>
            </div>
        {% endif %}

        <!-- Environment -->
        {% if land.environment %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-leaf me-2"></i>Environment
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.environment.items() %}
                        {% if key != 'score_breakdown' %}
                            <div class="d-flex justify-content-between align-items-center mb-2">
                                {% if key in ['sea_view', 'forest_view', 'mountain_view'] %}
                                    <span class="small">{{ key.replace('_view', '').replace('_', ' ').title() }} View</span>
                                    {% if value is sameas true %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% else %}
                                        <span class="text-muted small">no data</span>
                                    {% endif %}
                                {% else %}
                                    <span class="small">{{ key.replace('_', ' ').title() }}</span>
                                    {% if value is sameas true %}
                                        <i class="fas fa-check-circle text-success"></i>
                                    {% elif value is sameas false %}
                                        <i class="fas fa-times-circle text-danger"></i>
                                    {% else %}
                                        <span class="text-muted small">{{ value }}</span>
                                    {% endif %}
                                {% endif %}
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Services Quality -->
        {% if land.services_quality %}
            <div class="card mb-4">
                <div class="card-header">
                    <h6 class="card-title mb-0">
                        <i class="fas fa-star me-2"></i>Services Quality
                    </h6>
                </div>
                <div class="card-body">
                    {% for key, value in land.services_quality.items() %}
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="small">{{ key.replace('_', ' ').title() }}</span>
                            {% if value is number %}
                                <div>
                                    <span class="badge bg-warning">{{ "%.1f"|format(value) }}/5</span>
                                    <div class="small">
                                        {% for i in range(5) %}
                                            {% if i < value %}
                                                <i class="fas fa-star text-warning"></i>
                                            {% else %}
                                                <i class="far fa-star text-muted"></i>
                                            {% endif %}
                                        {% endfor %}
                                    </div>
                                </div>
                            {% else %}
                                <span class="text-muted small">{{ value }}</span>
                            {% endif %}
                        </div>
                    {% endfor %}
                </div>
            </div>
        {% endif %}

        <!-- Meta Information -->
        <div class="card">
            <div class="card-header">
                <h6 class="card-title mb-0">
                    <i class="fas fa-info-circle me-2"></i>Information
                </h6>
            </div>
            <div class="card-body">
                <div class="small">
                    <div class="mb-2">
                        <strong>Legal Status:</strong> {{ land.legal_status or 'Unknown' }}
                    </div>
                    <div class="mb-2">
                        <strong>Added:</strong> {% if land.created_at %}{{ land.created_at.strftime('%B %d, %Y at %H:%M') }}{% else %}Unknown{% endif %}
                    </div>
                    <div>
                        <strong>Email ID:</strong> <code>{{ land.source_email_id }}</code>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Score Modal -->
<div class="modal fade" id="editScoreModal" tabindex="-1" aria-labelledby="editScoreModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="{{ url_for('main.update_score', land_id=land.id) }}">
                <div class="modal-header">
                    <h5 class="modal-title" id="editScoreModalLabel">Edit Score</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="score" class="form-label">Manual Score (0-100)</label>
                        <input type="number" class="form-control" id="score" name="score" 
                               min="0" max="100" step="0.1" 
                               value="{{ '%.1f'|format(land.score_total) if land.score_total else 0 }}" required>
                        <div class="form-text">
                            Enter a score between 0 and 100. This will override the automatically calculated score.
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Score</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
function analyzeWithClaude(landId) {
    const button = event.target.closest('button');
    const originalContent = button.innerHTML;
    
    // Show loading state
    button.disabled = true;
    button.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Analyzing...';
    
    // Call API
    fetch(`/api/analyze/property/${landId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            // Show success message and reload to see the analysis
            alert('AI Analysis complete! The analysis has been saved.');
            window.location.reload();
        } else {
            alert('Analysis failed: ' + (data.error || 'Unknown error'));
        }
    })
    .catch(error => {
        alert('Error: ' + error);
    })
    .finally(() => {
        // Restore button
        button.disabled = false;
        button.innerHTML = originalContent;
    });
}
</script>
{% endblock %}
